========================================
Building Hardened FIPS Image
========================================
Image: coredns:v1.13.2-ubuntu-22.04-fips
Dockerfile: Dockerfile.hardened

#0 building with "default" instance using docker driver

#1 [internal] load build definition from Dockerfile.hardened
#1 transferring dockerfile: 48.61kB done
#1 DONE 0.0s

#2 [internal] load metadata for docker.io/library/ubuntu:22.04
#2 DONE 0.1s

#3 [internal] load .dockerignore
#3 transferring context: 2B done
#3 DONE 0.0s

#4 [go-builder 1/9] FROM docker.io/library/ubuntu:22.04@sha256:aa6efdd564b660b6df78df8f4bca20dbb8338c46fb696d4b45c4a57b8f66679f
#4 resolve docker.io/library/ubuntu:22.04@sha256:aa6efdd564b660b6df78df8f4bca20dbb8338c46fb696d4b45c4a57b8f66679f 0.0s done
#4 DONE 0.0s

#5 [internal] load build context
#5 transferring context: 115B done
#5 DONE 0.0s

#6 [stage-5 27/51] RUN groupadd sugroup 2>/dev/null || true && gpasswd -M '' sugroup &&     mkdir -p /etc/pam.d &&     if [ -f /etc/pam.d/su ]; then         grep -q "pam_wheel.so.*group=sugroup" /etc/pam.d/su || sed -i '/^auth.*pam_rootok\.so/a auth required pam_wheel.so use_uid group=sugroup' /etc/pam.d/su;     else         echo "auth sufficient pam_rootok.so" > /etc/pam.d/su &&         echo "auth required pam_wheel.so use_uid group=sugroup" >> /etc/pam.d/su &&         echo "@include common-auth" >> /etc/pam.d/su &&         echo "@include common-account" >> /etc/pam.d/su &&         echo "@include common-session" >> /etc/pam.d/su;     fi
#6 CACHED

#7 [stage-5  7/51] RUN set -eux;     echo "Installing FIPS OpenSSL to system locations...";     cp -av /usr/local/openssl/lib64/libssl.so* /usr/lib/x86_64-linux-gnu/ || true;     cp -av /usr/local/openssl/lib64/libcrypto.so* /usr/lib/x86_64-linux-gnu/ || true;     cp -av /usr/local/lib/libwolfssl.so* /usr/lib/x86_64-linux-gnu/ || true;     echo "/usr/local/openssl/lib64" > /etc/ld.so.conf.d/fips-openssl.conf;     echo "/usr/local/lib" >> /etc/ld.so.conf.d/fips-openssl.conf;     echo "/usr/lib/x86_64-linux-gnu" >> /etc/ld.so.conf.d/fips-openssl.conf;     ldconfig;     echo "FIPS OpenSSL installed to system locations"
#7 CACHED

#8 [app-builder 9/9] RUN set -eux;     echo "";     echo "========================================";     echo "CoreDNS Crypto Dependency Audit";     echo "========================================";     echo "";     echo "Scanning /app/coredns binary for cryptographic references...";     echo "";     X_CRYPTO_COUNT=$(strings /app/coredns 2>/dev/null | grep -c "golang.org/x/crypto" || echo 0);     if [ "$X_CRYPTO_COUNT" -gt 0 ]; then         echo "‚ö†Ô∏è  WARNING: Found $X_CRYPTO_COUNT golang.org/x/crypto references";         echo "";         echo "Details:";         echo "  Package: golang.org/x/crypto (v0.45.0 in go.mod)";         echo "  Used by: CoreDNS TLS plugins (DoT/DoH/DoH3)";         echo "  Expected: golang-fips/go SHOULD intercept these calls at runtime";         echo "";         echo "FIPS Compliance Path:";         echo "  CoreDNS ‚Üí golang.org/x/crypto ‚Üí golang-fips/go runtime";         echo "  ‚Üí OpenSSL 3.0.15 ‚Üí wolfProvider ‚Üí wolfSSL FIPS v5";         echo "";         echo "‚ö†Ô∏è  Action Required:";         echo "  Integration testing with TLS connections (DoT/DoH/DoH3) to verify";         echo "  crypto routing through FIPS-validated OpenSSL in production";         echo "";     else         echo "‚úì No golang.org/x/crypto references found";     fi;     X25519_COUNT=$(strings /app/coredns 2>/dev/null | grep -icE "x25519|curve25519" || echo 0);     if [ "$X25519_COUNT" -gt 0 ]; then         echo "‚ö†Ô∏è  WARNING: Found $X25519_COUNT X25519/curve25519 references";         echo "";         echo "Details:";         echo "  Algorithm: X25519 elliptic curve Diffie-Hellman";         echo "  Used in: TLS 1.3 key exchange (DoT/DoH/DoH3)";         echo "  FIPS Status: May be approved in FIPS 140-3";         echo "";         echo "Expected Behavior:";         echo "  golang-fips/go routes crypto/ecdh and crypto/tls calls to OpenSSL";         echo "  OpenSSL 3.0.15 uses wolfProvider ‚Üí wolfSSL FIPS v5 for operations";         echo "";         echo "‚ö†Ô∏è  Action Required:";         echo "  Test TLS connections in production environment";         echo "  Verify cipher suite negotiation uses FIPS-approved algorithms";         echo "  Monitor for TLS handshake errors";         echo "";     else         echo "‚ÑπÔ∏è  No X25519/curve25519 references found";     fi;     ED25519_COUNT=$(strings /app/coredns 2>/dev/null | grep -ic "ed25519" || echo 0);     if [ "$ED25519_COUNT" -gt 0 ]; then         echo "‚ÑπÔ∏è  INFO: Found $ED25519_COUNT Ed25519 references";         echo "";         echo "Details:";         echo "  Algorithm: Ed25519 signature algorithm";         echo "  Used in: DNSSEC record signatures, JWT token verification";         echo "  Operation: Signature VERIFICATION (non-cryptographic)";         echo "";         echo "FIPS Impact: LOW";         echo "  Signature verification is a public-key operation";         echo "  Does not involve key generation or signing (cryptographic operations)";         echo "";     else         echo "‚ÑπÔ∏è  No Ed25519 references found";     fi;     CHACHA20_COUNT=$(strings /app/coredns 2>/dev/null | grep -ic "chacha20" || echo 0);     if [ "$CHACHA20_COUNT" -gt 0 ]; then         echo "‚ö†Ô∏è  WARNING: Found $CHACHA20_COUNT ChaCha20 references";         echo "";         echo "Details:";         echo "  Algorithm: ChaCha20-Poly1305 AEAD cipher";         echo "  Used in: TLS 1.3 cipher suites (optional)";         echo "  FIPS Status: NOT FIPS-approved";         echo "";         echo "‚ö†Ô∏è  Action Required:";         echo "  Configure TLS to use only FIPS-approved cipher suites";         echo "  Example: AES-128-GCM-SHA256, AES-256-GCM-SHA384";         echo "  Disable ChaCha20-Poly1305 in TLS configuration";         echo "";     else         echo "‚úì No ChaCha20 references found";     fi;     echo "";     echo "Summary:";     echo "  Architecture: CoreDNS ‚Üí golang-fips/go ‚Üí OpenSSL 3 ‚Üí wolfProvider ‚Üí wolfSSL FIPS v5";     echo "  golang.org/x/crypto: $X_CRYPTO_COUNT references (expected for TLS plugins)";     echo "  X25519: $X25519_COUNT references (TLS 1.3 key exchange)";     echo "  Ed25519: $ED25519_COUNT references (DNSSEC/JWT verification)";     echo "  ChaCha20: $CHACHA20_COUNT references (should be 0 for FIPS)";     echo "";     echo "Next Steps:";     echo "  1. Run automated tests: ./tests/check-coredns-crypto-routing.sh";     echo "  2. Deploy to test environment with TLS enabled";     echo "  3. Test DoT, DoH, DoH3 with real DNS queries";     echo "  4. Verify TLS cipher suites in production logs";     echo "";     echo "========================================";     echo ""
#8 CACHED

#9 [stage-5  3/51] COPY --from=wolfssl-builder /usr/local/lib/libwolfssl.* /usr/local/lib/
#9 CACHED

#10 [stage-5 36/51] RUN echo "Defaults use_pty" > /etc/sudoers.d/99-stig-hardening &&     echo "Defaults logfile="/var/log/sudo.log"" >> /etc/sudoers.d/99-stig-hardening &&     echo "Defaults timestamp_timeout=0" >> /etc/sudoers.d/99-stig-hardening &&     chmod 0440 /etc/sudoers.d/99-stig-hardening
#10 CACHED

#11 [go-builder 5/9] COPY --from=wolfprov-builder /usr/local/openssl/lib64/ossl-modules/libwolfprov.so* /usr/local/openssl/lib64/ossl-modules/
#11 CACHED

#12 [stage-5 25/51] RUN sed -i 's/\(password.*pam_unix\.so.*\)obscure.*/\1obscure sha512/' /etc/pam.d/common-password ||     sed -i '/^password.*pam_unix\.so/s/yescrypt/sha512/' /etc/pam.d/common-password ||     sed -i '/^password.*pam_unix\.so/s/$/ sha512/' /etc/pam.d/common-password;     sed -i 's/\(password.*pam_unix\.so.*sha512\)/\1 remember=5/' /etc/pam.d/common-password
#12 CACHED

#13 [stage-5 41/51] RUN find /var/log -type f -exec chmod 0640 {} ; 2>/dev/null || true &&     find /var/log -type f -exec chown root:syslog {} ; 2>/dev/null || true
#13 CACHED

#14 [stage-5 43/51] RUN mkdir -p /etc/apt/apt.conf.d && cat > /etc/apt/apt.conf.d/90autoremove << 'APT_CONF_EOF'
#14 CACHED

#15 [stage-5 10/51] RUN set -eux;     echo "";     echo "========================================";     echo "Pre-Installation FIPS Verification";     echo "========================================";     echo "";     echo "OpenSSL Version:";     openssl version || { echo "ERROR: OpenSSL not working!"; exit 1; };     echo "";     echo "OpenSSL Providers:";     openssl list -providers || { echo "ERROR: Cannot list providers!"; exit 1; };     echo "";     echo "Checking for wolfProvider...";     if openssl list -providers | grep -q "wolfprov"; then         echo "‚úì SUCCESS: wolfProvider is loaded and active";     else         echo "‚úó ERROR: wolfProvider is NOT loaded!";         echo "Available providers:";         openssl list -providers || true;         exit 1;     fi;     echo "";     echo "‚úì Pre-installation FIPS verification passed";     echo "========================================"
#15 CACHED

#16 [app-builder 8/9] RUN set -eux;     echo "Cloning CoreDNS repository...";     git clone --depth 1 --branch v1.13.2         https://github.com/coredns/coredns.git /tmp/coredns;     cd /tmp/coredns;     echo "Building CoreDNS v1.13.2 with FIPS Go...";     go version;     echo "Downloading dependencies...";     go mod download;     echo "Building CoreDNS binary...";     go build -buildmode=pie         -ldflags="-s -w"         -o /app/coredns         .;     echo "Verifying CoreDNS binary...";     ls -lh /app/coredns;     echo "Checking binary linkage:";     ldd /app/coredns || echo "Note: Binary linkage check complete";     echo "Testing binary execution:";     /app/coredns --version 2>&1 || echo "Binary execution test complete";     cd /;     rm -rf /tmp/coredns
#16 CACHED

#17 [stage-5 33/51] RUN cat > /etc/sysctl.d/99-stig-hardening.conf << 'STIG_EOF'
#17 CACHED

#18 [app-builder 4/9] COPY --from=wolfssl-builder /usr/local/include/wolfssl /usr/local/include/wolfssl
#18 CACHED

#19 [stage-5 30/51] RUN sed -i 's/^UMASK.*/UMASK 077/' /etc/login.defs &&     sed -i '1i umask 077' /etc/profile &&     echo "umask 077" >> /etc/bash.bashrc &&     mkdir -p /etc/profile.d &&     echo "umask 077" > /etc/profile.d/umask.sh &&     chmod 0644 /etc/profile.d/umask.sh
#19 CACHED

#20 [app-builder 5/9] COPY --from=wolfssl-builder /usr/local/lib/libwolfssl.* /usr/local/lib/
#20 CACHED

#21 [stage-5 21/51] RUN sed -i 's/^PASS_MAX_DAYS.*/PASS_MAX_DAYS   60/' /etc/login.defs &&     sed -i 's/^PASS_MIN_DAYS.*/PASS_MIN_DAYS   7/' /etc/login.defs &&     sed -i 's/^PASS_WARN_AGE.*/PASS_WARN_AGE   14/' /etc/login.defs &&     sed -i 's/^ENCRYPT_METHOD.*/ENCRYPT_METHOD SHA512/' /etc/login.defs &&     sed -i 's/^# SHA_CRYPT_MIN_ROUNDS.*/SHA_CRYPT_MIN_ROUNDS 5000/' /etc/login.defs &&     sed -i 's/^# SHA_CRYPT_MAX_ROUNDS.*/SHA_CRYPT_MAX_ROUNDS 5000/' /etc/login.defs &&     useradd -D -f 30
#21 CACHED

#22 [stage-5 48/51] RUN set -eux;     groupadd -g 1001 coredns;     useradd -u 1001 -g coredns -s /bin/bash -m coredns
#22 CACHED

#23 [stage-5 15/51] RUN chmod +x /usr/local/bin/fips-startup-check
#23 CACHED

#24 [stage-5  4/51] COPY --from=wolfssl-builder /usr/local/include/wolfssl /usr/local/include/wolfssl
#24 CACHED

#25 [stage-5  6/51] RUN --mount=type=bind,from=wolfprov-builder,source=/usr/local,target=/mnt/wolfprov     set -eux;     echo "Searching for wolfProvider...";     find /mnt/wolfprov -name "libwolfprov.so*" -ls || true;     if [ -f "/mnt/wolfprov/lib/libwolfprov.so" ]; then         echo "Copying wolfProvider from /usr/local/lib/";         cp -v /mnt/wolfprov/lib/libwolfprov.so* /usr/local/openssl/lib64/ossl-modules/;         echo "Creating symlink without lib prefix for OpenSSL compatibility...";         ln -sf libwolfprov.so /usr/local/openssl/lib64/ossl-modules/wolfprov.so;     else         echo "ERROR: wolfProvider not found!";         exit 1;     fi;     echo "Final wolfProvider verification:";     ls -la /usr/local/openssl/lib64/ossl-modules/
#25 CACHED

#26 [stage-5 45/51] RUN usermod -g 0 root 2>/dev/null || true
#26 CACHED

#27 [wolfssl-builder 5/5] RUN set -eux;     gcc /tmp/fips-startup-check.c -o /usr/local/bin/fips-startup-check         -lwolfssl -I/usr/local/include;     chmod +x /usr/local/bin/fips-startup-check;     rm /tmp/fips-startup-check.c;     echo "FIPS startup check utility built successfully"
#27 CACHED

#28 [stage-5 38/51] RUN chmod 0750 /etc/audit/rules.d && chmod 0640 /etc/audit/rules.d/*.rules 2>/dev/null || true
#28 CACHED

#29 [stage-5 28/51] RUN mkdir -p /etc/security/limits.d &&     echo "* hard maxlogins 10" > /etc/security/limits.d/maxlogins.conf &&     echo "* hard core 0" > /etc/security/limits.d/core.conf &&     chmod 0644 /etc/security/limits.d/*.conf
#29 CACHED

#30 [stage-5 35/51] RUN mkdir -p /etc/ssh/sshd_config.d && cat > /etc/ssh/sshd_config.d/99-stig-hardening.conf << 'SSH_EOF'
#30 CACHED

#31 [app-builder 2/9] COPY --from=go-builder /usr/local/go-fips /usr/local/go-fips
#31 CACHED

#32 [wolfssl-builder 3/5] RUN --mount=type=secret,id=wolfssl_password,required=true     set -eux;     mkdir -p /usr/src;     curl -fsSLk "https://www.wolfssl.com/comm/wolfssl/wolfssl-5.8.2-commercial-fips-v5.2.3.7z" -o /tmp/wolfssl.7z;     PASSWORD=$(cat /run/secrets/wolfssl_password | tr -d '\n\r');     7z x /tmp/wolfssl.7z -o/usr/src -p"${PASSWORD}";     rm /tmp/wolfssl.7z;     find /usr/src -maxdepth 1 -type d -name "wolfssl*" -exec mv {} /usr/src/wolfssl ;;     cd /usr/src/wolfssl;     sed -i '/^#ifdef WOLFSSL_PYTHON/,/^#endif/d' wolfssl/wolfcrypt/settings.h || true;     ./configure         --prefix=/usr/local         --enable-fips=v5         --enable-opensslcoexist         --enable-cmac         --enable-keygen         --enable-sha         --enable-des3         --enable-aesctr         --enable-aesccm         --enable-x963kdf         --enable-compkey         --enable-certgen         --enable-aeskeywrap         --enable-enckeys         --enable-base16         --with-eccminsz=192         CPPFLAGS="-DHAVE_AES_ECB -DWOLFSSL_AES_DIRECT -DWC_RSA_NO_PADDING -DWOLFSSL_PUBLIC_MP -DHAVE_PUBLIC_FFDHE -DWOLFSSL_DH_EXTRA -DWOLFSSL_PSS_LONG_SALT -DWOLFSSL_PSS_SALT_LEN_DISCOVER -DRSA_MIN_SIZE=1024"     ;     make -j"$(nproc)";     ./fips-hash.sh;     make -j"$(nproc)";     make install;     ldconfig;     cd /;     rm -rf /usr/src/wolfssl;     echo "wolfSSL FIPS v5 installed successfully"
#32 CACHED

#33 [stage-5 20/51] RUN set -eux;     echo "";     echo "========================================";     echo "Final FIPS Compliance Verification";     echo "========================================";     echo "";     echo "[1/6] OpenSSL Version:";     /usr/local/openssl/bin/openssl version;     echo "";     echo "[2/6] OpenSSL Providers:";     /usr/local/openssl/bin/openssl list -providers;     echo "";     echo "[3/6] wolfProvider Module Location:";     ls -lah /usr/local/openssl/lib64/ossl-modules/;     echo "";     echo "[4/6] CoreDNS Binary:";     ls -lh /coredns;     echo "";     echo "[5/6] Verifying wolfProvider is Active:";     if /usr/local/openssl/bin/openssl list -providers | grep -q "wolfprov"; then         echo "‚úì wolfProvider is loaded and active";     else         echo "‚úó ERROR: wolfProvider is NOT loaded!";         exit 1;     fi;     echo "";     echo "[6/6] Scanning for Non-FIPS Crypto Libraries:";     FOUND_LIBS=$(find /usr/lib /lib -type f (         -name 'libgnutls*' -o         -name 'libnettle*' -o         -name 'libhogweed*' -o         -name 'libgcrypt*' -o         -name 'libk5crypto*'     ) 2>/dev/null | wc -l);     if [ "$FOUND_LIBS" -eq 0 ]; then         echo "‚úì No non-FIPS crypto libraries found";     else         echo "‚úó WARNING: Found $FOUND_LIBS non-FIPS crypto library files:";         find /usr/lib /lib -type f (             -name 'libgnutls*' -o             -name 'libnettle*' -o             -name 'libhogweed*' -o             -name 'libgcrypt*' -o             -name 'libk5crypto*'         ) 2>/dev/null || true;     fi;     echo "";     echo "========================================";     echo "‚úì FIPS Compliance Verification Complete";     echo "========================================";     echo "";     echo "Environment Summary:";     echo "  OPENSSL_CONF: /usr/local/openssl/ssl/openssl.cnf";     echo "  OPENSSL_MODULES: /usr/local/openssl/lib64/ossl-modules";     echo "  LD_LIBRARY_PATH: /usr/local/openssl/lib64:/usr/local/openssl/lib:/usr/local/lib:/usr/lib/x86_64-linux-gnu:/usr/lib/aarch64-linux-gnu:/usr/lib";     echo "  PATH: /usr/local/openssl/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin";     echo "";     echo "Architecture:";     echo "  CoreDNS ‚Üí golang-fips/go ‚Üí OpenSSL 3 ‚Üí wolfProvider ‚Üí wolfSSL FIPS v5";     echo ""
#33 CACHED

#34 [go-builder 3/9] COPY --from=wolfssl-builder /usr/local/include/wolfssl /usr/local/include/wolfssl
#34 CACHED

#35 [go-builder 2/9] COPY --from=openssl-builder /usr/local/openssl /usr/local/openssl
#35 CACHED

#36 [stage-5 16/51] COPY --from=app-builder /app/coredns /coredns
#36 CACHED

#37 [stage-5 17/51] RUN chmod +x /coredns
#37 CACHED

#38 [stage-5  5/51] RUN mkdir -p /usr/local/openssl/lib64/ossl-modules
#38 CACHED

#39 [app-builder 7/9] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends         build-essential         ca-certificates         curl         git         pkg-config     ;     rm -rf /var/lib/apt/lists/*
#39 CACHED

#40 [stage-5 22/51] RUN echo "minlen = 15" > /etc/security/pwquality.conf &&     echo "dcredit = -1" >> /etc/security/pwquality.conf &&     echo "ucredit = -1" >> /etc/security/pwquality.conf &&     echo "ocredit = -1" >> /etc/security/pwquality.conf &&     echo "lcredit = -1" >> /etc/security/pwquality.conf &&     echo "minclass = 4" >> /etc/security/pwquality.conf &&     echo "maxrepeat = 3" >> /etc/security/pwquality.conf &&     echo "maxsequence = 3" >> /etc/security/pwquality.conf &&     echo "dictcheck = 1" >> /etc/security/pwquality.conf &&     echo "enforcing = 1" >> /etc/security/pwquality.conf &&     echo "difok = 8" >> /etc/security/pwquality.conf
#40 CACHED

#41 [stage-5 11/51] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends         ca-certificates         iproute2         bash         curl         procps     ;     rm -rf /var/lib/apt/lists/*
#41 CACHED

#42 [stage-5 14/51] COPY --from=wolfssl-builder /usr/local/bin/fips-startup-check /usr/local/bin/fips-startup-check
#42 CACHED

#43 [stage-5 44/51] RUN cat > /etc/apt/apt.conf-stig << 'APT_CONF_STIG_EOF'
#43 CACHED

#44 [stage-5  8/51] RUN set -eux;     cp -av /usr/local/openssl/bin/openssl /usr/bin/openssl || true;     chmod 755 /usr/bin/openssl
#44 CACHED

#45 [stage-5 34/51] RUN echo "Authorized uses only. All activity may be monitored and reported." > /etc/motd &&     echo "Authorized uses only. All activity may be monitored and reported." > /etc/issue &&     echo "Authorized uses only. All activity may be monitored and reported." > /etc/issue.net
#45 CACHED

#46 [stage-5 19/51] RUN chmod +x /entrypoint.sh
#46 CACHED

#47 [stage-5 40/51] RUN find / -xdev -nouser -exec chown root {} ; 2>/dev/null || true &&     find / -xdev -nogroup -exec chgrp root {} ; 2>/dev/null || true &&     chmod 0750 /var/log && chown root:syslog /var/log 2>/dev/null || chown root:root /var/log &&     find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type d -exec chmod 0755 {} ; 2>/dev/null || true &&     find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type f -exec chown root {} ; 2>/dev/null || true &&     find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type f -exec chgrp root {} ; 2>/dev/null || true
#47 CACHED

#48 [stage-5 32/51] RUN echo > /etc/securetty &&     chmod 0600 /etc/securetty
#48 CACHED

#49 [stage-5 29/51] RUN chmod 0644 /etc/passwd /etc/group &&     chmod 0640 /etc/shadow /etc/gshadow &&     chown root:root /etc/passwd /etc/group &&     chown root:shadow /etc/shadow /etc/gshadow &&     chmod 0644 /etc/passwd- /etc/group- 2>/dev/null || true &&     chmod 0000 /etc/shadow- /etc/gshadow- 2>/dev/null || true
#49 CACHED

#50 [go-builder 7/9] RUN set -eux;     ARCH=$(uname -m);     if [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then GO_ARCH="arm64"; else GO_ARCH="amd64"; fi;     curl -fsSL https://go.dev/dl/go1.23.4.linux-${GO_ARCH}.tar.gz -o /tmp/go.tar.gz;     tar -C /usr/local -xzf /tmp/go.tar.gz;     mv /usr/local/go /usr/local/go-bootstrap;     rm /tmp/go.tar.gz
#50 CACHED

#51 [app-builder 6/9] COPY --from=wolfprov-builder /usr/local/openssl/lib64/ossl-modules/libwolfprov.so* /usr/local/openssl/lib64/ossl-modules/
#51 CACHED

#52 [stage-5 37/51] RUN mkdir -p /etc/audit/rules.d && cat > /etc/audit/rules.d/stig.rules << 'AUDIT_EOF'
#52 CACHED

#53 [stage-5 42/51] RUN apt-get purge -y xinetd rsh-client talk telnet 2>/dev/null || true &&     apt-get autoremove -y || true &&     apt-get clean || true &&     rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
#53 CACHED

#54 [wolfssl-builder 4/5] COPY fips-startup-check.c /tmp/fips-startup-check.c
#54 CACHED

#55 [go-builder 8/9] RUN set -eux;     unset GOROOT;     export PATH="/usr/local/go-bootstrap/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin";     git config --global user.email "builder@fips.local";     git config --global user.name "FIPS Builder";     git clone --branch go1.24-fips-release https://github.com/golang-fips/go.git /tmp/go-fips-repo;     cd /tmp/go-fips-repo;     git submodule update --init --recursive;     cd /tmp/go-fips-repo;     ./scripts/full-initialize-repo.sh;     cd /tmp/go-fips-repo/go/src;     CGO_ENABLED=1     CGO_CFLAGS="-I/usr/local/openssl/include -I/usr/local/include"     CGO_LDFLAGS="-L/usr/local/openssl/lib64 -L/usr/local/openssl/lib -L/usr/local/lib"     ./make.bash;     FINAL_GOROOT=/usr/local/go-fips;     mv /tmp/go-fips-repo/go ${FINAL_GOROOT};     rm -rf /tmp/go-fips-repo;     ${FINAL_GOROOT}/bin/go version
#55 CACHED

#56 [stage-5 24/51] RUN sed -i '/^auth.*pam_unix\.so/i auth required pam_faillock.so preauth' /etc/pam.d/common-auth &&     sed -i '/^auth.*pam_unix\.so/a auth [default=die] pam_faillock.so authfail' /etc/pam.d/common-auth &&     sed -i '/^auth.*pam_permit\.so/i auth sufficient pam_faillock.so authsucc' /etc/pam.d/common-auth &&     sed -i '/^account.*pam_unix\.so/a account required pam_faillock.so' /etc/pam.d/common-account || true &&     if ! grep -q "pam_faillock.so" /etc/pam.d/common-account; then sed -i '1i account required pam_faillock.so' /etc/pam.d/common-account; fi
#56 CACHED

#57 [wolfssl-builder 2/5] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends         build-essential         ca-certificates         curl         git         autoconf         automake         libtool         p7zip-full     ;     rm -rf /var/lib/apt/lists/*
#57 CACHED

#58 [stage-5 47/51] RUN find / -perm /6000 -type f -exec chmod a-s {} ; 2>/dev/null || true
#58 CACHED

#59 [wolfprov-builder 6/6] RUN set -eux;     cd /tmp;     git clone --depth 1 --branch v1.1.0 https://github.com/wolfSSL/wolfProvider.git wolfProvider;     cd wolfProvider;     ./autogen.sh;     ./configure         --prefix=/usr/local         --with-openssl=/usr/local/openssl         --with-wolfssl=/usr/local     ;     make -j"$(nproc)";     make install;     echo "Checking installed wolfProvider files:";     find /usr/local -name "libwolfprov.so*" -ls || echo "wolfProvider not in expected location";     find /usr/local/openssl -name "libwolfprov.so*" -ls || echo "wolfProvider not in OpenSSL location"
#59 CACHED

#60 [stage-5 23/51] RUN sed -i '1i auth required pam_faildelay.so delay=4000000' /etc/pam.d/common-auth &&     echo "deny = 3" > /etc/security/faillock.conf &&     echo "fail_interval = 900" >> /etc/security/faillock.conf &&     echo "unlock_time = 900" >> /etc/security/faillock.conf &&     echo "silent" >> /etc/security/faillock.conf &&     echo "audit" >> /etc/security/faillock.conf
#60 CACHED

#61 [openssl-builder 3/3] RUN set -eux;     cd /tmp;     curl -fsSL "https://www.openssl.org/source/openssl-3.0.18.tar.gz" -o openssl.tar.gz;     tar -xzf openssl.tar.gz;     cd "openssl-3.0.18";     ARCH=$(uname -m);     if [ "$ARCH" = "x86_64" ]; then OPENSSL_TARGET="linux-x86_64"; OPENSSL_LIBDIR="lib64";     elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then OPENSSL_TARGET="linux-aarch64"; OPENSSL_LIBDIR="lib";     else OPENSSL_TARGET="linux-generic64"; OPENSSL_LIBDIR="lib"; fi;     ./Configure --prefix=/usr/local/openssl --libdir=$OPENSSL_LIBDIR --openssldir=/usr/local/openssl/ssl enable-fips shared $OPENSSL_TARGET;     make -j"$(nproc)";     make install_sw install_fips install_ssldirs;     if [ -d "/usr/local/openssl/lib64" ] && [ ! -d "/usr/local/openssl/lib" ]; then ln -sf lib64 /usr/local/openssl/lib;     elif [ -d "/usr/local/openssl/lib" ] && [ ! -d "/usr/local/openssl/lib64" ]; then ln -sf lib /usr/local/openssl/lib64; fi;     cd /tmp; rm -rf openssl*
#61 CACHED

#62 [stage-5 39/51] RUN find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type f -perm /022 -exec chmod go-w {} ; 2>/dev/null || true
#62 CACHED

#63 [stage-5 13/51] RUN set -eux;     echo "Removing system OpenSSL packages...";     apt-get remove -y libssl3 openssl libssl-dev 2>/dev/null || true;     apt-get autoremove -y 2>/dev/null || true;     find /usr/lib /lib -name "libssl.so.3" -delete 2>/dev/null || true;     find /usr/lib /lib -name "libcrypto.so.3" -delete 2>/dev/null || true;     cp -av /usr/local/openssl/lib64/libssl.so* /usr/lib/x86_64-linux-gnu/ 2>/dev/null || true;     cp -av /usr/local/openssl/lib64/libcrypto.so* /usr/lib/x86_64-linux-gnu/ 2>/dev/null || true;     cp -av /usr/local/lib/libwolfssl.so* /usr/lib/x86_64-linux-gnu/ 2>/dev/null || true;     ldconfig;     echo "System OpenSSL packages removed"
#63 CACHED

#64 [wolfprov-builder 5/6] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends         build-essential         ca-certificates         git         autoconf         automake         libtool         pkg-config     ;     rm -rf /var/lib/apt/lists/*
#64 CACHED

#65 [stage-5 46/51] RUN set -eux;     echo "========================================";     echo "Final System Executable Permission Check";     echo "========================================";     find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type f -exec chmod 0755 {} ; 2>/dev/null || true;     find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type f -exec chown root:root {} ; 2>/dev/null || true;     find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type d -exec chmod 0755 {} ; 2>/dev/null || true;     echo "‚úì All system executables have restrictive permissions (0755)"
#65 CACHED

#66 [go-builder 4/9] COPY --from=wolfssl-builder /usr/local/lib/libwolfssl.* /usr/local/lib/
#66 CACHED

#67 [stage-5 12/51] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends         libpam-pwquality         libpam-runtime         auditd         rsyslog-openssl         sudo         libopenscap8;     apt-get clean;     rm -rf /var/lib/apt/lists/*;         echo "========================================";     echo "Verifying FIPS Compliance of Installed Packages";     echo "========================================";         echo "Checking rsyslog linkage:";     ldd /usr/sbin/rsyslogd | grep -E "libssl|libcrypto" || echo "  (no OpenSSL linkage)";         if ldd /usr/sbin/rsyslogd 2>/dev/null | grep libssl; then         if ldd /usr/sbin/rsyslogd | grep libssl | grep -q "/usr/lib/x86_64-linux-gnu"; then             echo "‚úì rsyslog-openssl uses FIPS OpenSSL (TLS logging is FIPS-compliant)";         else             echo "ERROR: rsyslog links to non-FIPS OpenSSL!";             ldd /usr/sbin/rsyslogd | grep libssl;             exit 1;         fi;     fi;         if command -v oscap &>/dev/null; then         echo "‚úì OpenSCAP installed for compliance scanning";         oscap --version | head -1 || true;     fi;         echo "‚úì All hardening packages verified";     echo "========================================"
#67 CACHED

#68 [stage-5 31/51] RUN usermod -g 0 root && for user in $(awk -F: '($3 < 1000 && $1 != "root" && $1 != "sync" && $1 != "shutdown" && $1 != "halt") {print $1}' /etc/passwd); do usermod -s /usr/sbin/nologin "$user" 2>/dev/null || true; done
#68 CACHED

#69 [openssl-builder 2/3] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends         build-essential         ca-certificates         curl         perl     ;     rm -rf /var/lib/apt/lists/*
#69 CACHED

#70 [go-builder 6/9] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends         build-essential         ca-certificates         git         curl         pkg-config     ;     rm -rf /var/lib/apt/lists/*
#70 CACHED

#71 [stage-5 18/51] COPY entrypoint.sh /entrypoint.sh
#71 CACHED

#72 [stage-5 26/51] RUN mkdir -p /etc/pam.d &&     if [ -f /etc/pam.d/login ]; then         sed -i 's/^session.*optional.*pam_lastlog\.so.*/session required pam_lastlog.so showfailed/' /etc/pam.d/login;         grep -q "pam_lastlog.so showfailed" /etc/pam.d/login || echo "session required pam_lastlog.so showfailed" >> /etc/pam.d/login;     else         echo "session required pam_lastlog.so showfailed" > /etc/pam.d/login;     fi
#72 CACHED

#73 [go-builder 9/9] RUN set -eux;     echo "";     echo "========================================";     echo "CVE-2024-9355 Verification";     echo "========================================";     echo "Checking golang-fips/openssl version for CVE-2024-9355...";     cd /usr/local/go-fips;     if [ -f "go.mod" ]; then         OPENSSL_VERSION=$(grep "github.com/golang-fips/openssl" go.mod | head -1 | awk '{print $2}' || echo "unknown");         echo "Detected golang-fips/openssl version: $OPENSSL_VERSION";         echo "";         case "$OPENSSL_VERSION" in             v2.0.[0-3]|v2.0.0-*|v2.0.1-*|v2.0.2-*|v2.0.3-*|v0.*|v1.*)                 echo "‚ö†Ô∏è  WARNING: golang-fips/openssl version $OPENSSL_VERSION may be VULNERABLE";                 echo "";                 echo "Vulnerability Details:";                 echo "  CVE ID: CVE-2024-9355";                 echo "  Severity: HIGH (CVSS 6.5)";                 echo "  Issue: Uninitialized buffer in RSA key generation";                 echo "  Affected: golang-fips/openssl ‚â§ v2.0.3";                 echo "  Fixed in: v2.0.4+";                 echo "";                 echo "Recommendation:";                 echo "  Update golang-fips/go to use golang-fips/openssl v2.0.4 or later";                 echo "  This is detected at BUILD TIME for awareness";                 echo "";                 ;;             v2.0.[4-9]|v2.0.[1-9][0-9]|v2.[1-9]*|v[3-9]*)                 echo "‚úì PASS: golang-fips/openssl $OPENSSL_VERSION is PATCHED";                 echo "  CVE-2024-9355 does not affect this version";                 ;;             *)                 echo "‚ÑπÔ∏è  INFO: golang-fips/openssl version: $OPENSSL_VERSION";                 echo "  Could not determine vulnerability status automatically";                 echo "  Please verify version >= v2.0.4 manually";                 ;;         esac;     else         echo "‚ö†Ô∏è  WARNING: Could not find go.mod in /usr/local/go-fips";         echo "  Unable to verify golang-fips/openssl version";     fi;     echo "========================================";     echo ""
#73 CACHED

#74 [stage-5  9/51] COPY openssl-wolfprov.cnf /usr/local/openssl/ssl/openssl.cnf
#74 CACHED

#75 [app-builder 3/9] COPY --from=openssl-builder /usr/local/openssl /usr/local/openssl
#75 CACHED

#76 [stage-5 49/51] RUN set -eux;     mkdir -p /etc/coredns;     mkdir -p /var/log/coredns;     chown -R 1001:1001 /etc/coredns /var/log/coredns;     chmod 755 /etc/coredns /var/log/coredns
#76 CACHED

#77 [stage-5 50/51] RUN set -eux;     echo "========================================";     echo "Removing Package Manager Binaries";     echo "========================================";     rm -f /usr/bin/apt /usr/bin/apt-get /usr/bin/apt-cache;     rm -f /usr/bin/dpkg /usr/bin/dpkg-deb /usr/bin/dpkg-query;     rm -f /usr/bin/aptitude /usr/bin/apt-key;     echo "‚úì Package manager binaries removed (apt, dpkg)";     echo "Note: OpenSCAP scanning must be done before this step"
#77 0.169 ========================================
#77 0.169 Removing Package Manager Binaries
#77 0.169 ========================================
#77 0.169 + echo ========================================
#77 0.169 + echo Removing Package Manager Binaries
#77 0.169 + echo ========================================
#77 0.169 + rm -f /usr/bin/apt /usr/bin/apt-get /usr/bin/apt-cache
#77 0.170 rm: cannot remove '/usr/bin/apt': Permission denied
#77 0.170 rm: cannot remove '/usr/bin/apt-get': Permission denied
#77 0.170 rm: cannot remove '/usr/bin/apt-cache': Permission denied
#77 ERROR: process "/bin/sh -c set -eux;     echo \"========================================\";     echo \"Removing Package Manager Binaries\";     echo \"========================================\";     rm -f /usr/bin/apt /usr/bin/apt-get /usr/bin/apt-cache;     rm -f /usr/bin/dpkg /usr/bin/dpkg-deb /usr/bin/dpkg-query;     rm -f /usr/bin/aptitude /usr/bin/apt-key;     echo \"‚úì Package manager binaries removed (apt, dpkg)\";     echo \"Note: OpenSCAP scanning must be done before this step\"" did not complete successfully: exit code: 1
------
 > [stage-5 50/51] RUN set -eux;     echo "========================================";     echo "Removing Package Manager Binaries";     echo "========================================";     rm -f /usr/bin/apt /usr/bin/apt-get /usr/bin/apt-cache;     rm -f /usr/bin/dpkg /usr/bin/dpkg-deb /usr/bin/dpkg-query;     rm -f /usr/bin/aptitude /usr/bin/apt-key;     echo "‚úì Package manager binaries removed (apt, dpkg)";     echo "Note: OpenSCAP scanning must be done before this step":
0.169 ========================================
0.169 Removing Package Manager Binaries
0.169 ========================================
0.169 + echo ========================================
0.169 + echo Removing Package Manager Binaries
0.169 + echo ========================================
0.169 + rm -f /usr/bin/apt /usr/bin/apt-get /usr/bin/apt-cache
0.170 rm: cannot remove '/usr/bin/apt': Permission denied
0.170 rm: cannot remove '/usr/bin/apt-get': Permission denied
0.170 rm: cannot remove '/usr/bin/apt-cache': Permission denied
------
Dockerfile.hardened:1075
--------------------
 1074 |     ################################################################################
 1075 | >>> RUN set -eux; \
 1076 | >>>     echo "========================================"; \
 1077 | >>>     echo "Removing Package Manager Binaries"; \
 1078 | >>>     echo "========================================"; \
 1079 | >>>     rm -f /usr/bin/apt /usr/bin/apt-get /usr/bin/apt-cache; \
 1080 | >>>     rm -f /usr/bin/dpkg /usr/bin/dpkg-deb /usr/bin/dpkg-query; \
 1081 | >>>     rm -f /usr/bin/aptitude /usr/bin/apt-key; \
 1082 | >>>     echo "‚úì Package manager binaries removed (apt, dpkg)"; \
 1083 | >>>     echo "Note: OpenSCAP scanning must be done before this step"
 1084 |     
--------------------
ERROR: failed to build: failed to solve: process "/bin/sh -c set -eux;     echo \"========================================\";     echo \"Removing Package Manager Binaries\";     echo \"========================================\";     rm -f /usr/bin/apt /usr/bin/apt-get /usr/bin/apt-cache;     rm -f /usr/bin/dpkg /usr/bin/dpkg-deb /usr/bin/dpkg-query;     rm -f /usr/bin/aptitude /usr/bin/apt-key;     echo \"‚úì Package manager binaries removed (apt, dpkg)\";     echo \"Note: OpenSCAP scanning must be done before this step\"" did not complete successfully: exit code: 1

========================================
[0;31m‚úó BUILD FAILED[0m
========================================
========================================
Building Hardened FIPS Image
========================================
Image: coredns:v1.13.2-ubuntu-22.04-fips
Dockerfile: Dockerfile.hardened

#0 building with "default" instance using docker driver

#1 [internal] load build definition from Dockerfile.hardened
#1 transferring dockerfile: 49.56kB done
#1 DONE 0.0s

#2 [internal] load metadata for docker.io/library/ubuntu:22.04
#2 DONE 0.1s

#3 [internal] load .dockerignore
#3 transferring context: 2B done
#3 DONE 0.0s

#4 [go-builder 1/9] FROM docker.io/library/ubuntu:22.04@sha256:aa6efdd564b660b6df78df8f4bca20dbb8338c46fb696d4b45c4a57b8f66679f
#4 resolve docker.io/library/ubuntu:22.04@sha256:aa6efdd564b660b6df78df8f4bca20dbb8338c46fb696d4b45c4a57b8f66679f 0.0s done
#4 DONE 0.0s

#5 [internal] load build context
#5 transferring context: 115B done
#5 DONE 0.0s

#6 [stage-5 46/51] RUN set -eux;     echo "========================================";     echo "Final System Executable Permission Check";     echo "========================================";     find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type f -exec chmod 0755 {} ; 2>/dev/null || true;     find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type f -exec chown root:root {} ; 2>/dev/null || true;     find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type d -exec chmod 0755 {} ; 2>/dev/null || true;     echo "‚úì All system executables have restrictive permissions (0755)"
#6 CACHED

#7 [stage-5 11/51] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends         ca-certificates         iproute2         bash         curl         procps     ;     rm -rf /var/lib/apt/lists/*
#7 CACHED

#8 [stage-5 14/51] COPY --from=wolfssl-builder /usr/local/bin/fips-startup-check /usr/local/bin/fips-startup-check
#8 CACHED

#9 [stage-5 38/51] RUN chmod 0750 /etc/audit/rules.d && chmod 0640 /etc/audit/rules.d/*.rules 2>/dev/null || true
#9 CACHED

#10 [stage-5 42/51] RUN apt-get purge -y xinetd rsh-client talk telnet 2>/dev/null || true &&     apt-get autoremove -y || true &&     apt-get clean || true &&     rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
#10 CACHED

#11 [app-builder 6/9] COPY --from=wolfprov-builder /usr/local/openssl/lib64/ossl-modules/libwolfprov.so* /usr/local/openssl/lib64/ossl-modules/
#11 CACHED

#12 [stage-5 37/51] RUN mkdir -p /etc/audit/rules.d && cat > /etc/audit/rules.d/stig.rules << 'AUDIT_EOF'
#12 CACHED

#13 [stage-5 29/51] RUN chmod 0644 /etc/passwd /etc/group &&     chmod 0640 /etc/shadow /etc/gshadow &&     chown root:root /etc/passwd /etc/group &&     chown root:shadow /etc/shadow /etc/gshadow &&     chmod 0644 /etc/passwd- /etc/group- 2>/dev/null || true &&     chmod 0000 /etc/shadow- /etc/gshadow- 2>/dev/null || true
#13 CACHED

#14 [stage-5  5/51] RUN mkdir -p /usr/local/openssl/lib64/ossl-modules
#14 CACHED

#15 [stage-5 16/51] COPY --from=app-builder /app/coredns /coredns
#15 CACHED

#16 [stage-5 34/51] RUN echo "Authorized uses only. All activity may be monitored and reported." > /etc/motd &&     echo "Authorized uses only. All activity may be monitored and reported." > /etc/issue &&     echo "Authorized uses only. All activity may be monitored and reported." > /etc/issue.net
#16 CACHED

#17 [go-builder 7/9] RUN set -eux;     ARCH=$(uname -m);     if [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then GO_ARCH="arm64"; else GO_ARCH="amd64"; fi;     curl -fsSL https://go.dev/dl/go1.23.4.linux-${GO_ARCH}.tar.gz -o /tmp/go.tar.gz;     tar -C /usr/local -xzf /tmp/go.tar.gz;     mv /usr/local/go /usr/local/go-bootstrap;     rm /tmp/go.tar.gz
#17 CACHED

#18 [stage-5  8/51] RUN set -eux;     cp -av /usr/local/openssl/bin/openssl /usr/bin/openssl || true;     chmod 755 /usr/bin/openssl
#18 CACHED

#19 [stage-5 21/51] RUN sed -i 's/^PASS_MAX_DAYS.*/PASS_MAX_DAYS   60/' /etc/login.defs &&     sed -i 's/^PASS_MIN_DAYS.*/PASS_MIN_DAYS   7/' /etc/login.defs &&     sed -i 's/^PASS_WARN_AGE.*/PASS_WARN_AGE   14/' /etc/login.defs &&     sed -i 's/^ENCRYPT_METHOD.*/ENCRYPT_METHOD SHA512/' /etc/login.defs &&     sed -i 's/^# SHA_CRYPT_MIN_ROUNDS.*/SHA_CRYPT_MIN_ROUNDS 5000/' /etc/login.defs &&     sed -i 's/^# SHA_CRYPT_MAX_ROUNDS.*/SHA_CRYPT_MAX_ROUNDS 5000/' /etc/login.defs &&     useradd -D -f 30
#19 CACHED

#20 [stage-5 45/51] RUN usermod -g 0 root 2>/dev/null || true
#20 CACHED

#21 [app-builder 4/9] COPY --from=wolfssl-builder /usr/local/include/wolfssl /usr/local/include/wolfssl
#21 CACHED

#22 [stage-5 26/51] RUN mkdir -p /etc/pam.d &&     if [ -f /etc/pam.d/login ]; then         sed -i 's/^session.*optional.*pam_lastlog\.so.*/session required pam_lastlog.so showfailed/' /etc/pam.d/login;         grep -q "pam_lastlog.so showfailed" /etc/pam.d/login || echo "session required pam_lastlog.so showfailed" >> /etc/pam.d/login;     else         echo "session required pam_lastlog.so showfailed" > /etc/pam.d/login;     fi
#22 CACHED

#23 [go-builder 8/9] RUN set -eux;     unset GOROOT;     export PATH="/usr/local/go-bootstrap/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin";     git config --global user.email "builder@fips.local";     git config --global user.name "FIPS Builder";     git clone --branch go1.24-fips-release https://github.com/golang-fips/go.git /tmp/go-fips-repo;     cd /tmp/go-fips-repo;     git submodule update --init --recursive;     cd /tmp/go-fips-repo;     ./scripts/full-initialize-repo.sh;     cd /tmp/go-fips-repo/go/src;     CGO_ENABLED=1     CGO_CFLAGS="-I/usr/local/openssl/include -I/usr/local/include"     CGO_LDFLAGS="-L/usr/local/openssl/lib64 -L/usr/local/openssl/lib -L/usr/local/lib"     ./make.bash;     FINAL_GOROOT=/usr/local/go-fips;     mv /tmp/go-fips-repo/go ${FINAL_GOROOT};     rm -rf /tmp/go-fips-repo;     ${FINAL_GOROOT}/bin/go version
#23 CACHED

#24 [stage-5 24/51] RUN sed -i '/^auth.*pam_unix\.so/i auth required pam_faillock.so preauth' /etc/pam.d/common-auth &&     sed -i '/^auth.*pam_unix\.so/a auth [default=die] pam_faillock.so authfail' /etc/pam.d/common-auth &&     sed -i '/^auth.*pam_permit\.so/i auth sufficient pam_faillock.so authsucc' /etc/pam.d/common-auth &&     sed -i '/^account.*pam_unix\.so/a account required pam_faillock.so' /etc/pam.d/common-account || true &&     if ! grep -q "pam_faillock.so" /etc/pam.d/common-account; then sed -i '1i account required pam_faillock.so' /etc/pam.d/common-account; fi
#24 CACHED

#25 [wolfssl-builder 4/5] COPY fips-startup-check.c /tmp/fips-startup-check.c
#25 CACHED

#26 [stage-5 48/51] RUN set -eux;     groupadd -g 1001 coredns;     useradd -u 1001 -g coredns -s /bin/bash -m coredns
#26 CACHED

#27 [stage-5 31/51] RUN usermod -g 0 root && for user in $(awk -F: '($3 < 1000 && $1 != "root" && $1 != "sync" && $1 != "shutdown" && $1 != "halt") {print $1}' /etc/passwd); do usermod -s /usr/sbin/nologin "$user" 2>/dev/null || true; done
#27 CACHED

#28 [stage-5 19/51] RUN chmod +x /entrypoint.sh
#28 CACHED

#29 [stage-5 18/51] COPY entrypoint.sh /entrypoint.sh
#29 CACHED

#30 [stage-5 33/51] RUN cat > /etc/sysctl.d/99-stig-hardening.conf << 'STIG_EOF'
#30 CACHED

#31 [stage-5 36/51] RUN echo "Defaults use_pty" > /etc/sudoers.d/99-stig-hardening &&     echo "Defaults logfile="/var/log/sudo.log"" >> /etc/sudoers.d/99-stig-hardening &&     echo "Defaults timestamp_timeout=0" >> /etc/sudoers.d/99-stig-hardening &&     chmod 0440 /etc/sudoers.d/99-stig-hardening
#31 CACHED

#32 [stage-5 32/51] RUN echo > /etc/securetty &&     chmod 0600 /etc/securetty
#32 CACHED

#33 [app-builder 2/9] COPY --from=go-builder /usr/local/go-fips /usr/local/go-fips
#33 CACHED

#34 [stage-5 43/51] RUN mkdir -p /etc/apt/apt.conf.d && cat > /etc/apt/apt.conf.d/90autoremove << 'APT_CONF_EOF'
#34 CACHED

#35 [wolfprov-builder 5/6] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends         build-essential         ca-certificates         git         autoconf         automake         libtool         pkg-config     ;     rm -rf /var/lib/apt/lists/*
#35 CACHED

#36 [stage-5 15/51] RUN chmod +x /usr/local/bin/fips-startup-check
#36 CACHED

#37 [app-builder 3/9] COPY --from=openssl-builder /usr/local/openssl /usr/local/openssl
#37 CACHED

#38 [wolfprov-builder 6/6] RUN set -eux;     cd /tmp;     git clone --depth 1 --branch v1.1.0 https://github.com/wolfSSL/wolfProvider.git wolfProvider;     cd wolfProvider;     ./autogen.sh;     ./configure         --prefix=/usr/local         --with-openssl=/usr/local/openssl         --with-wolfssl=/usr/local     ;     make -j"$(nproc)";     make install;     echo "Checking installed wolfProvider files:";     find /usr/local -name "libwolfprov.so*" -ls || echo "wolfProvider not in expected location";     find /usr/local/openssl -name "libwolfprov.so*" -ls || echo "wolfProvider not in OpenSSL location"
#38 CACHED

#39 [app-builder 7/9] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends         build-essential         ca-certificates         curl         git         pkg-config     ;     rm -rf /var/lib/apt/lists/*
#39 CACHED

#40 [stage-5 40/51] RUN find / -xdev -nouser -exec chown root {} ; 2>/dev/null || true &&     find / -xdev -nogroup -exec chgrp root {} ; 2>/dev/null || true &&     chmod 0750 /var/log && chown root:syslog /var/log 2>/dev/null || chown root:root /var/log &&     find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type d -exec chmod 0755 {} ; 2>/dev/null || true &&     find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type f -exec chown root {} ; 2>/dev/null || true &&     find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type f -exec chgrp root {} ; 2>/dev/null || true
#40 CACHED

#41 [go-builder 6/9] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends         build-essential         ca-certificates         git         curl         pkg-config     ;     rm -rf /var/lib/apt/lists/*
#41 CACHED

#42 [stage-5 17/51] RUN chmod +x /coredns
#42 CACHED

#43 [stage-5 22/51] RUN echo "minlen = 15" > /etc/security/pwquality.conf &&     echo "dcredit = -1" >> /etc/security/pwquality.conf &&     echo "ucredit = -1" >> /etc/security/pwquality.conf &&     echo "ocredit = -1" >> /etc/security/pwquality.conf &&     echo "lcredit = -1" >> /etc/security/pwquality.conf &&     echo "minclass = 4" >> /etc/security/pwquality.conf &&     echo "maxrepeat = 3" >> /etc/security/pwquality.conf &&     echo "maxsequence = 3" >> /etc/security/pwquality.conf &&     echo "dictcheck = 1" >> /etc/security/pwquality.conf &&     echo "enforcing = 1" >> /etc/security/pwquality.conf &&     echo "difok = 8" >> /etc/security/pwquality.conf
#43 CACHED

#44 [wolfssl-builder 2/5] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends         build-essential         ca-certificates         curl         git         autoconf         automake         libtool         p7zip-full     ;     rm -rf /var/lib/apt/lists/*
#44 CACHED

#45 [stage-5  3/51] COPY --from=wolfssl-builder /usr/local/lib/libwolfssl.* /usr/local/lib/
#45 CACHED

#46 [stage-5 35/51] RUN mkdir -p /etc/ssh/sshd_config.d && cat > /etc/ssh/sshd_config.d/99-stig-hardening.conf << 'SSH_EOF'
#46 CACHED

#47 [go-builder 9/9] RUN set -eux;     echo "";     echo "========================================";     echo "CVE-2024-9355 Verification";     echo "========================================";     echo "Checking golang-fips/openssl version for CVE-2024-9355...";     cd /usr/local/go-fips;     if [ -f "go.mod" ]; then         OPENSSL_VERSION=$(grep "github.com/golang-fips/openssl" go.mod | head -1 | awk '{print $2}' || echo "unknown");         echo "Detected golang-fips/openssl version: $OPENSSL_VERSION";         echo "";         case "$OPENSSL_VERSION" in             v2.0.[0-3]|v2.0.0-*|v2.0.1-*|v2.0.2-*|v2.0.3-*|v0.*|v1.*)                 echo "‚ö†Ô∏è  WARNING: golang-fips/openssl version $OPENSSL_VERSION may be VULNERABLE";                 echo "";                 echo "Vulnerability Details:";                 echo "  CVE ID: CVE-2024-9355";                 echo "  Severity: HIGH (CVSS 6.5)";                 echo "  Issue: Uninitialized buffer in RSA key generation";                 echo "  Affected: golang-fips/openssl ‚â§ v2.0.3";                 echo "  Fixed in: v2.0.4+";                 echo "";                 echo "Recommendation:";                 echo "  Update golang-fips/go to use golang-fips/openssl v2.0.4 or later";                 echo "  This is detected at BUILD TIME for awareness";                 echo "";                 ;;             v2.0.[4-9]|v2.0.[1-9][0-9]|v2.[1-9]*|v[3-9]*)                 echo "‚úì PASS: golang-fips/openssl $OPENSSL_VERSION is PATCHED";                 echo "  CVE-2024-9355 does not affect this version";                 ;;             *)                 echo "‚ÑπÔ∏è  INFO: golang-fips/openssl version: $OPENSSL_VERSION";                 echo "  Could not determine vulnerability status automatically";                 echo "  Please verify version >= v2.0.4 manually";                 ;;         esac;     else         echo "‚ö†Ô∏è  WARNING: Could not find go.mod in /usr/local/go-fips";         echo "  Unable to verify golang-fips/openssl version";     fi;     echo "========================================";     echo ""
#47 CACHED

#48 [go-builder 2/9] COPY --from=openssl-builder /usr/local/openssl /usr/local/openssl
#48 CACHED

#49 [stage-5 10/51] RUN set -eux;     echo "";     echo "========================================";     echo "Pre-Installation FIPS Verification";     echo "========================================";     echo "";     echo "OpenSSL Version:";     openssl version || { echo "ERROR: OpenSSL not working!"; exit 1; };     echo "";     echo "OpenSSL Providers:";     openssl list -providers || { echo "ERROR: Cannot list providers!"; exit 1; };     echo "";     echo "Checking for wolfProvider...";     if openssl list -providers | grep -q "wolfprov"; then         echo "‚úì SUCCESS: wolfProvider is loaded and active";     else         echo "‚úó ERROR: wolfProvider is NOT loaded!";         echo "Available providers:";         openssl list -providers || true;         exit 1;     fi;     echo "";     echo "‚úì Pre-installation FIPS verification passed";     echo "========================================"
#49 CACHED

#50 [stage-5 28/51] RUN mkdir -p /etc/security/limits.d &&     echo "* hard maxlogins 10" > /etc/security/limits.d/maxlogins.conf &&     echo "* hard core 0" > /etc/security/limits.d/core.conf &&     chmod 0644 /etc/security/limits.d/*.conf
#50 CACHED

#51 [go-builder 4/9] COPY --from=wolfssl-builder /usr/local/lib/libwolfssl.* /usr/local/lib/
#51 CACHED

#52 [stage-5 27/51] RUN groupadd sugroup 2>/dev/null || true && gpasswd -M '' sugroup &&     mkdir -p /etc/pam.d &&     if [ -f /etc/pam.d/su ]; then         grep -q "pam_wheel.so.*group=sugroup" /etc/pam.d/su || sed -i '/^auth.*pam_rootok\.so/a auth required pam_wheel.so use_uid group=sugroup' /etc/pam.d/su;     else         echo "auth sufficient pam_rootok.so" > /etc/pam.d/su &&         echo "auth required pam_wheel.so use_uid group=sugroup" >> /etc/pam.d/su &&         echo "@include common-auth" >> /etc/pam.d/su &&         echo "@include common-account" >> /etc/pam.d/su &&         echo "@include common-session" >> /etc/pam.d/su;     fi
#52 CACHED

#53 [go-builder 5/9] COPY --from=wolfprov-builder /usr/local/openssl/lib64/ossl-modules/libwolfprov.so* /usr/local/openssl/lib64/ossl-modules/
#53 CACHED

#54 [stage-5 30/51] RUN sed -i 's/^UMASK.*/UMASK 077/' /etc/login.defs &&     sed -i '1i umask 077' /etc/profile &&     echo "umask 077" >> /etc/bash.bashrc &&     mkdir -p /etc/profile.d &&     echo "umask 077" > /etc/profile.d/umask.sh &&     chmod 0644 /etc/profile.d/umask.sh
#54 CACHED

#55 [stage-5 12/51] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends         libpam-pwquality         libpam-runtime         auditd         rsyslog-openssl         sudo         libopenscap8;     apt-get clean;     rm -rf /var/lib/apt/lists/*;         echo "========================================";     echo "Verifying FIPS Compliance of Installed Packages";     echo "========================================";         echo "Checking rsyslog linkage:";     ldd /usr/sbin/rsyslogd | grep -E "libssl|libcrypto" || echo "  (no OpenSSL linkage)";         if ldd /usr/sbin/rsyslogd 2>/dev/null | grep libssl; then         if ldd /usr/sbin/rsyslogd | grep libssl | grep -q "/usr/lib/x86_64-linux-gnu"; then             echo "‚úì rsyslog-openssl uses FIPS OpenSSL (TLS logging is FIPS-compliant)";         else             echo "ERROR: rsyslog links to non-FIPS OpenSSL!";             ldd /usr/sbin/rsyslogd | grep libssl;             exit 1;         fi;     fi;         if command -v oscap &>/dev/null; then         echo "‚úì OpenSCAP installed for compliance scanning";         oscap --version | head -1 || true;     fi;         echo "‚úì All hardening packages verified";     echo "========================================"
#55 CACHED

#56 [stage-5 13/51] RUN set -eux;     echo "Removing system OpenSSL packages...";     apt-get remove -y libssl3 openssl libssl-dev 2>/dev/null || true;     apt-get autoremove -y 2>/dev/null || true;     find /usr/lib /lib -name "libssl.so.3" -delete 2>/dev/null || true;     find /usr/lib /lib -name "libcrypto.so.3" -delete 2>/dev/null || true;     cp -av /usr/local/openssl/lib64/libssl.so* /usr/lib/x86_64-linux-gnu/ 2>/dev/null || true;     cp -av /usr/local/openssl/lib64/libcrypto.so* /usr/lib/x86_64-linux-gnu/ 2>/dev/null || true;     cp -av /usr/local/lib/libwolfssl.so* /usr/lib/x86_64-linux-gnu/ 2>/dev/null || true;     ldconfig;     echo "System OpenSSL packages removed"
#56 CACHED

#57 [stage-5 41/51] RUN find /var/log -type f -exec chmod 0640 {} ; 2>/dev/null || true &&     find /var/log -type f -exec chown root:syslog {} ; 2>/dev/null || true
#57 CACHED

#58 [stage-5  6/51] RUN --mount=type=bind,from=wolfprov-builder,source=/usr/local,target=/mnt/wolfprov     set -eux;     echo "Searching for wolfProvider...";     find /mnt/wolfprov -name "libwolfprov.so*" -ls || true;     if [ -f "/mnt/wolfprov/lib/libwolfprov.so" ]; then         echo "Copying wolfProvider from /usr/local/lib/";         cp -v /mnt/wolfprov/lib/libwolfprov.so* /usr/local/openssl/lib64/ossl-modules/;         echo "Creating symlink without lib prefix for OpenSSL compatibility...";         ln -sf libwolfprov.so /usr/local/openssl/lib64/ossl-modules/wolfprov.so;     else         echo "ERROR: wolfProvider not found!";         exit 1;     fi;     echo "Final wolfProvider verification:";     ls -la /usr/local/openssl/lib64/ossl-modules/
#58 CACHED

#59 [stage-5 20/51] RUN set -eux;     echo "";     echo "========================================";     echo "Final FIPS Compliance Verification";     echo "========================================";     echo "";     echo "[1/6] OpenSSL Version:";     /usr/local/openssl/bin/openssl version;     echo "";     echo "[2/6] OpenSSL Providers:";     /usr/local/openssl/bin/openssl list -providers;     echo "";     echo "[3/6] wolfProvider Module Location:";     ls -lah /usr/local/openssl/lib64/ossl-modules/;     echo "";     echo "[4/6] CoreDNS Binary:";     ls -lh /coredns;     echo "";     echo "[5/6] Verifying wolfProvider is Active:";     if /usr/local/openssl/bin/openssl list -providers | grep -q "wolfprov"; then         echo "‚úì wolfProvider is loaded and active";     else         echo "‚úó ERROR: wolfProvider is NOT loaded!";         exit 1;     fi;     echo "";     echo "[6/6] Scanning for Non-FIPS Crypto Libraries:";     FOUND_LIBS=$(find /usr/lib /lib -type f (         -name 'libgnutls*' -o         -name 'libnettle*' -o         -name 'libhogweed*' -o         -name 'libgcrypt*' -o         -name 'libk5crypto*'     ) 2>/dev/null | wc -l);     if [ "$FOUND_LIBS" -eq 0 ]; then         echo "‚úì No non-FIPS crypto libraries found";     else         echo "‚úó WARNING: Found $FOUND_LIBS non-FIPS crypto library files:";         find /usr/lib /lib -type f (             -name 'libgnutls*' -o             -name 'libnettle*' -o             -name 'libhogweed*' -o             -name 'libgcrypt*' -o             -name 'libk5crypto*'         ) 2>/dev/null || true;     fi;     echo "";     echo "========================================";     echo "‚úì FIPS Compliance Verification Complete";     echo "========================================";     echo "";     echo "Environment Summary:";     echo "  OPENSSL_CONF: /usr/local/openssl/ssl/openssl.cnf";     echo "  OPENSSL_MODULES: /usr/local/openssl/lib64/ossl-modules";     echo "  LD_LIBRARY_PATH: /usr/local/openssl/lib64:/usr/local/openssl/lib:/usr/local/lib:/usr/lib/x86_64-linux-gnu:/usr/lib/aarch64-linux-gnu:/usr/lib";     echo "  PATH: /usr/local/openssl/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin";     echo "";     echo "Architecture:";     echo "  CoreDNS ‚Üí golang-fips/go ‚Üí OpenSSL 3 ‚Üí wolfProvider ‚Üí wolfSSL FIPS v5";     echo ""
#59 CACHED

#60 [stage-5  9/51] COPY openssl-wolfprov.cnf /usr/local/openssl/ssl/openssl.cnf
#60 CACHED

#61 [openssl-builder 3/3] RUN set -eux;     cd /tmp;     curl -fsSL "https://www.openssl.org/source/openssl-3.0.18.tar.gz" -o openssl.tar.gz;     tar -xzf openssl.tar.gz;     cd "openssl-3.0.18";     ARCH=$(uname -m);     if [ "$ARCH" = "x86_64" ]; then OPENSSL_TARGET="linux-x86_64"; OPENSSL_LIBDIR="lib64";     elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then OPENSSL_TARGET="linux-aarch64"; OPENSSL_LIBDIR="lib";     else OPENSSL_TARGET="linux-generic64"; OPENSSL_LIBDIR="lib"; fi;     ./Configure --prefix=/usr/local/openssl --libdir=$OPENSSL_LIBDIR --openssldir=/usr/local/openssl/ssl enable-fips shared $OPENSSL_TARGET;     make -j"$(nproc)";     make install_sw install_fips install_ssldirs;     if [ -d "/usr/local/openssl/lib64" ] && [ ! -d "/usr/local/openssl/lib" ]; then ln -sf lib64 /usr/local/openssl/lib;     elif [ -d "/usr/local/openssl/lib" ] && [ ! -d "/usr/local/openssl/lib64" ]; then ln -sf lib /usr/local/openssl/lib64; fi;     cd /tmp; rm -rf openssl*
#61 CACHED

#62 [stage-5  7/51] RUN set -eux;     echo "Installing FIPS OpenSSL to system locations...";     cp -av /usr/local/openssl/lib64/libssl.so* /usr/lib/x86_64-linux-gnu/ || true;     cp -av /usr/local/openssl/lib64/libcrypto.so* /usr/lib/x86_64-linux-gnu/ || true;     cp -av /usr/local/lib/libwolfssl.so* /usr/lib/x86_64-linux-gnu/ || true;     echo "/usr/local/openssl/lib64" > /etc/ld.so.conf.d/fips-openssl.conf;     echo "/usr/local/lib" >> /etc/ld.so.conf.d/fips-openssl.conf;     echo "/usr/lib/x86_64-linux-gnu" >> /etc/ld.so.conf.d/fips-openssl.conf;     ldconfig;     echo "FIPS OpenSSL installed to system locations"
#62 CACHED

#63 [stage-5  4/51] COPY --from=wolfssl-builder /usr/local/include/wolfssl /usr/local/include/wolfssl
#63 CACHED

#64 [stage-5 44/51] RUN cat > /etc/apt/apt.conf-stig << 'APT_CONF_STIG_EOF'
#64 CACHED

#65 [wolfssl-builder 3/5] RUN --mount=type=secret,id=wolfssl_password,required=true     set -eux;     mkdir -p /usr/src;     curl -fsSLk "https://www.wolfssl.com/comm/wolfssl/wolfssl-5.8.2-commercial-fips-v5.2.3.7z" -o /tmp/wolfssl.7z;     PASSWORD=$(cat /run/secrets/wolfssl_password | tr -d '\n\r');     7z x /tmp/wolfssl.7z -o/usr/src -p"${PASSWORD}";     rm /tmp/wolfssl.7z;     find /usr/src -maxdepth 1 -type d -name "wolfssl*" -exec mv {} /usr/src/wolfssl ;;     cd /usr/src/wolfssl;     sed -i '/^#ifdef WOLFSSL_PYTHON/,/^#endif/d' wolfssl/wolfcrypt/settings.h || true;     ./configure         --prefix=/usr/local         --enable-fips=v5         --enable-opensslcoexist         --enable-cmac         --enable-keygen         --enable-sha         --enable-des3         --enable-aesctr         --enable-aesccm         --enable-x963kdf         --enable-compkey         --enable-certgen         --enable-aeskeywrap         --enable-enckeys         --enable-base16         --with-eccminsz=192         CPPFLAGS="-DHAVE_AES_ECB -DWOLFSSL_AES_DIRECT -DWC_RSA_NO_PADDING -DWOLFSSL_PUBLIC_MP -DHAVE_PUBLIC_FFDHE -DWOLFSSL_DH_EXTRA -DWOLFSSL_PSS_LONG_SALT -DWOLFSSL_PSS_SALT_LEN_DISCOVER -DRSA_MIN_SIZE=1024"     ;     make -j"$(nproc)";     ./fips-hash.sh;     make -j"$(nproc)";     make install;     ldconfig;     cd /;     rm -rf /usr/src/wolfssl;     echo "wolfSSL FIPS v5 installed successfully"
#65 CACHED

#66 [stage-5 47/51] RUN find / -perm /6000 -type f -exec chmod a-s {} ; 2>/dev/null || true
#66 CACHED

#67 [stage-5 23/51] RUN sed -i '1i auth required pam_faildelay.so delay=4000000' /etc/pam.d/common-auth &&     echo "deny = 3" > /etc/security/faillock.conf &&     echo "fail_interval = 900" >> /etc/security/faillock.conf &&     echo "unlock_time = 900" >> /etc/security/faillock.conf &&     echo "silent" >> /etc/security/faillock.conf &&     echo "audit" >> /etc/security/faillock.conf
#67 CACHED

#68 [openssl-builder 2/3] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends         build-essential         ca-certificates         curl         perl     ;     rm -rf /var/lib/apt/lists/*
#68 CACHED

#69 [app-builder 9/9] RUN set -eux;     echo "";     echo "========================================";     echo "CoreDNS Crypto Dependency Audit";     echo "========================================";     echo "";     echo "Scanning /app/coredns binary for cryptographic references...";     echo "";     X_CRYPTO_COUNT=$(strings /app/coredns 2>/dev/null | grep -c "golang.org/x/crypto" || echo 0);     if [ "$X_CRYPTO_COUNT" -gt 0 ]; then         echo "‚ö†Ô∏è  WARNING: Found $X_CRYPTO_COUNT golang.org/x/crypto references";         echo "";         echo "Details:";         echo "  Package: golang.org/x/crypto (v0.45.0 in go.mod)";         echo "  Used by: CoreDNS TLS plugins (DoT/DoH/DoH3)";         echo "  Expected: golang-fips/go SHOULD intercept these calls at runtime";         echo "";         echo "FIPS Compliance Path:";         echo "  CoreDNS ‚Üí golang.org/x/crypto ‚Üí golang-fips/go runtime";         echo "  ‚Üí OpenSSL 3.0.15 ‚Üí wolfProvider ‚Üí wolfSSL FIPS v5";         echo "";         echo "‚ö†Ô∏è  Action Required:";         echo "  Integration testing with TLS connections (DoT/DoH/DoH3) to verify";         echo "  crypto routing through FIPS-validated OpenSSL in production";         echo "";     else         echo "‚úì No golang.org/x/crypto references found";     fi;     X25519_COUNT=$(strings /app/coredns 2>/dev/null | grep -icE "x25519|curve25519" || echo 0);     if [ "$X25519_COUNT" -gt 0 ]; then         echo "‚ö†Ô∏è  WARNING: Found $X25519_COUNT X25519/curve25519 references";         echo "";         echo "Details:";         echo "  Algorithm: X25519 elliptic curve Diffie-Hellman";         echo "  Used in: TLS 1.3 key exchange (DoT/DoH/DoH3)";         echo "  FIPS Status: May be approved in FIPS 140-3";         echo "";         echo "Expected Behavior:";         echo "  golang-fips/go routes crypto/ecdh and crypto/tls calls to OpenSSL";         echo "  OpenSSL 3.0.15 uses wolfProvider ‚Üí wolfSSL FIPS v5 for operations";         echo "";         echo "‚ö†Ô∏è  Action Required:";         echo "  Test TLS connections in production environment";         echo "  Verify cipher suite negotiation uses FIPS-approved algorithms";         echo "  Monitor for TLS handshake errors";         echo "";     else         echo "‚ÑπÔ∏è  No X25519/curve25519 references found";     fi;     ED25519_COUNT=$(strings /app/coredns 2>/dev/null | grep -ic "ed25519" || echo 0);     if [ "$ED25519_COUNT" -gt 0 ]; then         echo "‚ÑπÔ∏è  INFO: Found $ED25519_COUNT Ed25519 references";         echo "";         echo "Details:";         echo "  Algorithm: Ed25519 signature algorithm";         echo "  Used in: DNSSEC record signatures, JWT token verification";         echo "  Operation: Signature VERIFICATION (non-cryptographic)";         echo "";         echo "FIPS Impact: LOW";         echo "  Signature verification is a public-key operation";         echo "  Does not involve key generation or signing (cryptographic operations)";         echo "";     else         echo "‚ÑπÔ∏è  No Ed25519 references found";     fi;     CHACHA20_COUNT=$(strings /app/coredns 2>/dev/null | grep -ic "chacha20" || echo 0);     if [ "$CHACHA20_COUNT" -gt 0 ]; then         echo "‚ö†Ô∏è  WARNING: Found $CHACHA20_COUNT ChaCha20 references";         echo "";         echo "Details:";         echo "  Algorithm: ChaCha20-Poly1305 AEAD cipher";         echo "  Used in: TLS 1.3 cipher suites (optional)";         echo "  FIPS Status: NOT FIPS-approved";         echo "";         echo "‚ö†Ô∏è  Action Required:";         echo "  Configure TLS to use only FIPS-approved cipher suites";         echo "  Example: AES-128-GCM-SHA256, AES-256-GCM-SHA384";         echo "  Disable ChaCha20-Poly1305 in TLS configuration";         echo "";     else         echo "‚úì No ChaCha20 references found";     fi;     echo "";     echo "Summary:";     echo "  Architecture: CoreDNS ‚Üí golang-fips/go ‚Üí OpenSSL 3 ‚Üí wolfProvider ‚Üí wolfSSL FIPS v5";     echo "  golang.org/x/crypto: $X_CRYPTO_COUNT references (expected for TLS plugins)";     echo "  X25519: $X25519_COUNT references (TLS 1.3 key exchange)";     echo "  Ed25519: $ED25519_COUNT references (DNSSEC/JWT verification)";     echo "  ChaCha20: $CHACHA20_COUNT references (should be 0 for FIPS)";     echo "";     echo "Next Steps:";     echo "  1. Run automated tests: ./tests/check-coredns-crypto-routing.sh";     echo "  2. Deploy to test environment with TLS enabled";     echo "  3. Test DoT, DoH, DoH3 with real DNS queries";     echo "  4. Verify TLS cipher suites in production logs";     echo "";     echo "========================================";     echo ""
#69 CACHED

#70 [go-builder 3/9] COPY --from=wolfssl-builder /usr/local/include/wolfssl /usr/local/include/wolfssl
#70 CACHED

#71 [wolfssl-builder 5/5] RUN set -eux;     gcc /tmp/fips-startup-check.c -o /usr/local/bin/fips-startup-check         -lwolfssl -I/usr/local/include;     chmod +x /usr/local/bin/fips-startup-check;     rm /tmp/fips-startup-check.c;     echo "FIPS startup check utility built successfully"
#71 CACHED

#72 [app-builder 5/9] COPY --from=wolfssl-builder /usr/local/lib/libwolfssl.* /usr/local/lib/
#72 CACHED

#73 [stage-5 25/51] RUN sed -i 's/\(password.*pam_unix\.so.*\)obscure.*/\1obscure sha512/' /etc/pam.d/common-password ||     sed -i '/^password.*pam_unix\.so/s/yescrypt/sha512/' /etc/pam.d/common-password ||     sed -i '/^password.*pam_unix\.so/s/$/ sha512/' /etc/pam.d/common-password;     sed -i 's/\(password.*pam_unix\.so.*sha512\)/\1 remember=5/' /etc/pam.d/common-password
#73 CACHED

#74 [app-builder 8/9] RUN set -eux;     echo "Cloning CoreDNS repository...";     git clone --depth 1 --branch v1.13.2         https://github.com/coredns/coredns.git /tmp/coredns;     cd /tmp/coredns;     echo "Building CoreDNS v1.13.2 with FIPS Go...";     go version;     echo "Downloading dependencies...";     go mod download;     echo "Building CoreDNS binary...";     go build -buildmode=pie         -ldflags="-s -w"         -o /app/coredns         .;     echo "Verifying CoreDNS binary...";     ls -lh /app/coredns;     echo "Checking binary linkage:";     ldd /app/coredns || echo "Note: Binary linkage check complete";     echo "Testing binary execution:";     /app/coredns --version 2>&1 || echo "Binary execution test complete";     cd /;     rm -rf /tmp/coredns
#74 CACHED

#75 [stage-5 39/51] RUN find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type f -perm /022 -exec chmod go-w {} ; 2>/dev/null || true
#75 CACHED

#76 [stage-5 49/51] RUN set -eux;     mkdir -p /etc/coredns;     mkdir -p /var/log/coredns;     chown -R 1001:1001 /etc/coredns /var/log/coredns;     chmod 755 /etc/coredns /var/log/coredns
#76 CACHED

#77 [stage-5 50/51] RUN set -eux;     echo "========================================";     echo "Removing Package Manager Binaries";     echo "========================================";     dpkg-divert --add --rename --divert /usr/bin/apt.real /usr/bin/apt 2>/dev/null || true;     dpkg-divert --add --rename --divert /usr/bin/apt-get.real /usr/bin/apt-get 2>/dev/null || true;     dpkg-divert --add --rename --divert /usr/bin/apt-cache.real /usr/bin/apt-cache 2>/dev/null || true;     dpkg-divert --add --rename --divert /usr/bin/dpkg.real /usr/bin/dpkg 2>/dev/null || true;     dpkg-divert --add --rename --divert /usr/bin/dpkg-deb.real /usr/bin/dpkg-deb 2>/dev/null || true;     dpkg-divert --add --rename --divert /usr/bin/dpkg-query.real /usr/bin/dpkg-query 2>/dev/null || true;     rm -f /usr/bin/apt.real /usr/bin/apt-get.real /usr/bin/apt-cache.real;     rm -f /usr/bin/dpkg.real /usr/bin/dpkg-deb.real /usr/bin/dpkg-query.real;     rm -f /usr/bin/aptitude /usr/bin/apt-key;     rm -f /usr/bin/apt /usr/bin/apt-get /usr/bin/apt-cache 2>/dev/null || true;     rm -f /usr/bin/dpkg /usr/bin/dpkg-deb /usr/bin/dpkg-query 2>/dev/null || true;     echo "‚úì Package manager binaries removed (apt, dpkg)";     echo "Note: OpenSCAP scanning must be done before this step"
#77 0.171 + echo ========================================
#77 0.171 + echo Removing Package Manager Binaries
#77 0.171 + echo ========================================
#77 0.171 + dpkg-divert --add --rename --divert /usr/bin/apt.real /usr/bin/apt
#77 0.171 ========================================
#77 0.171 Removing Package Manager Binaries
#77 0.171 ========================================
#77 0.174 Adding 'local diversion of /usr/bin/apt to /usr/bin/apt.real'
#77 0.175 + true
#77 0.175 + dpkg-divert --add --rename --divert /usr/bin/apt-get.real /usr/bin/apt-get
#77 0.177 Adding 'local diversion of /usr/bin/apt-get to /usr/bin/apt-get.real'
#77 0.178 + true
#77 0.178 + dpkg-divert --add --rename --divert /usr/bin/apt-cache.real /usr/bin/apt-cache
#77 0.181 Adding 'local diversion of /usr/bin/apt-cache to /usr/bin/apt-cache.real'
#77 0.181 + true
#77 0.181 + dpkg-divert --add --rename --divert /usr/bin/dpkg.real /usr/bin/dpkg
#77 0.184 Adding 'local diversion of /usr/bin/dpkg to /usr/bin/dpkg.real'
#77 0.184 + true
#77 0.185 + dpkg-divert --add --rename --divert /usr/bin/dpkg-deb.real /usr/bin/dpkg-deb
#77 0.187 Adding 'local diversion of /usr/bin/dpkg-deb to /usr/bin/dpkg-deb.real'
#77 0.188 + true
#77 0.188 + dpkg-divert --add --rename --divert /usr/bin/dpkg-query.real /usr/bin/dpkg-query
#77 0.191 Adding 'local diversion of /usr/bin/dpkg-query to /usr/bin/dpkg-query.real'
#77 0.191 + true
#77 0.191 + rm -f /usr/bin/apt.real /usr/bin/apt-get.real /usr/bin/apt-cache.real
#77 0.192 + rm -f /usr/bin/dpkg.real /usr/bin/dpkg-deb.real /usr/bin/dpkg-query.real
#77 0.193 + rm -f /usr/bin/aptitude /usr/bin/apt-key
#77 0.194 rm: cannot remove '/usr/bin/apt-key': Permission denied
#77 ERROR: process "/bin/sh -c set -eux;     echo \"========================================\";     echo \"Removing Package Manager Binaries\";     echo \"========================================\";     dpkg-divert --add --rename --divert /usr/bin/apt.real /usr/bin/apt 2>/dev/null || true;     dpkg-divert --add --rename --divert /usr/bin/apt-get.real /usr/bin/apt-get 2>/dev/null || true;     dpkg-divert --add --rename --divert /usr/bin/apt-cache.real /usr/bin/apt-cache 2>/dev/null || true;     dpkg-divert --add --rename --divert /usr/bin/dpkg.real /usr/bin/dpkg 2>/dev/null || true;     dpkg-divert --add --rename --divert /usr/bin/dpkg-deb.real /usr/bin/dpkg-deb 2>/dev/null || true;     dpkg-divert --add --rename --divert /usr/bin/dpkg-query.real /usr/bin/dpkg-query 2>/dev/null || true;     rm -f /usr/bin/apt.real /usr/bin/apt-get.real /usr/bin/apt-cache.real;     rm -f /usr/bin/dpkg.real /usr/bin/dpkg-deb.real /usr/bin/dpkg-query.real;     rm -f /usr/bin/aptitude /usr/bin/apt-key;     rm -f /usr/bin/apt /usr/bin/apt-get /usr/bin/apt-cache 2>/dev/null || true;     rm -f /usr/bin/dpkg /usr/bin/dpkg-deb /usr/bin/dpkg-query 2>/dev/null || true;     echo \"‚úì Package manager binaries removed (apt, dpkg)\";     echo \"Note: OpenSCAP scanning must be done before this step\"" did not complete successfully: exit code: 1
------
 > [stage-5 50/51] RUN set -eux;     echo "========================================";     echo "Removing Package Manager Binaries";     echo "========================================";     dpkg-divert --add --rename --divert /usr/bin/apt.real /usr/bin/apt 2>/dev/null || true;     dpkg-divert --add --rename --divert /usr/bin/apt-get.real /usr/bin/apt-get 2>/dev/null || true;     dpkg-divert --add --rename --divert /usr/bin/apt-cache.real /usr/bin/apt-cache 2>/dev/null || true;     dpkg-divert --add --rename --divert /usr/bin/dpkg.real /usr/bin/dpkg 2>/dev/null || true;     dpkg-divert --add --rename --divert /usr/bin/dpkg-deb.real /usr/bin/dpkg-deb 2>/dev/null || true;     dpkg-divert --add --rename --divert /usr/bin/dpkg-query.real /usr/bin/dpkg-query 2>/dev/null || true;     rm -f /usr/bin/apt.real /usr/bin/apt-get.real /usr/bin/apt-cache.real;     rm -f /usr/bin/dpkg.real /usr/bin/dpkg-deb.real /usr/bin/dpkg-query.real;     rm -f /usr/bin/aptitude /usr/bin/apt-key;     rm -f /usr/bin/apt /usr/bin/apt-get /usr/bin/apt-cache 2>/dev/null || true;     rm -f /usr/bin/dpkg /usr/bin/dpkg-deb /usr/bin/dpkg-query 2>/dev/null || true;     echo "‚úì Package manager binaries removed (apt, dpkg)";     echo "Note: OpenSCAP scanning must be done before this step":
0.185 + dpkg-divert --add --rename --divert /usr/bin/dpkg-deb.real /usr/bin/dpkg-deb
0.187 Adding 'local diversion of /usr/bin/dpkg-deb to /usr/bin/dpkg-deb.real'
0.188 + true
0.188 + dpkg-divert --add --rename --divert /usr/bin/dpkg-query.real /usr/bin/dpkg-query
0.191 Adding 'local diversion of /usr/bin/dpkg-query to /usr/bin/dpkg-query.real'
0.191 + true
0.191 + rm -f /usr/bin/apt.real /usr/bin/apt-get.real /usr/bin/apt-cache.real
0.192 + rm -f /usr/bin/dpkg.real /usr/bin/dpkg-deb.real /usr/bin/dpkg-query.real
0.193 + rm -f /usr/bin/aptitude /usr/bin/apt-key
0.194 rm: cannot remove '/usr/bin/apt-key': Permission denied
------
Dockerfile.hardened:1075
--------------------
 1074 |     ################################################################################
 1075 | >>> RUN set -eux; \
 1076 | >>>     echo "========================================"; \
 1077 | >>>     echo "Removing Package Manager Binaries"; \
 1078 | >>>     echo "========================================"; \
 1079 | >>>     # Use dpkg-divert to override package protection
 1080 | >>>     dpkg-divert --add --rename --divert /usr/bin/apt.real /usr/bin/apt 2>/dev/null || true; \
 1081 | >>>     dpkg-divert --add --rename --divert /usr/bin/apt-get.real /usr/bin/apt-get 2>/dev/null || true; \
 1082 | >>>     dpkg-divert --add --rename --divert /usr/bin/apt-cache.real /usr/bin/apt-cache 2>/dev/null || true; \
 1083 | >>>     dpkg-divert --add --rename --divert /usr/bin/dpkg.real /usr/bin/dpkg 2>/dev/null || true; \
 1084 | >>>     dpkg-divert --add --rename --divert /usr/bin/dpkg-deb.real /usr/bin/dpkg-deb 2>/dev/null || true; \
 1085 | >>>     dpkg-divert --add --rename --divert /usr/bin/dpkg-query.real /usr/bin/dpkg-query 2>/dev/null || true; \
 1086 | >>>     # Now remove the renamed files
 1087 | >>>     rm -f /usr/bin/apt.real /usr/bin/apt-get.real /usr/bin/apt-cache.real; \
 1088 | >>>     rm -f /usr/bin/dpkg.real /usr/bin/dpkg-deb.real /usr/bin/dpkg-query.real; \
 1089 | >>>     rm -f /usr/bin/aptitude /usr/bin/apt-key; \
 1090 | >>>     # Also remove the original paths if they still exist
 1091 | >>>     rm -f /usr/bin/apt /usr/bin/apt-get /usr/bin/apt-cache 2>/dev/null || true; \
 1092 | >>>     rm -f /usr/bin/dpkg /usr/bin/dpkg-deb /usr/bin/dpkg-query 2>/dev/null || true; \
 1093 | >>>     echo "‚úì Package manager binaries removed (apt, dpkg)"; \
 1094 | >>>     echo "Note: OpenSCAP scanning must be done before this step"
 1095 |     
--------------------
ERROR: failed to build: failed to solve: process "/bin/sh -c set -eux;     echo \"========================================\";     echo \"Removing Package Manager Binaries\";     echo \"========================================\";     dpkg-divert --add --rename --divert /usr/bin/apt.real /usr/bin/apt 2>/dev/null || true;     dpkg-divert --add --rename --divert /usr/bin/apt-get.real /usr/bin/apt-get 2>/dev/null || true;     dpkg-divert --add --rename --divert /usr/bin/apt-cache.real /usr/bin/apt-cache 2>/dev/null || true;     dpkg-divert --add --rename --divert /usr/bin/dpkg.real /usr/bin/dpkg 2>/dev/null || true;     dpkg-divert --add --rename --divert /usr/bin/dpkg-deb.real /usr/bin/dpkg-deb 2>/dev/null || true;     dpkg-divert --add --rename --divert /usr/bin/dpkg-query.real /usr/bin/dpkg-query 2>/dev/null || true;     rm -f /usr/bin/apt.real /usr/bin/apt-get.real /usr/bin/apt-cache.real;     rm -f /usr/bin/dpkg.real /usr/bin/dpkg-deb.real /usr/bin/dpkg-query.real;     rm -f /usr/bin/aptitude /usr/bin/apt-key;     rm -f /usr/bin/apt /usr/bin/apt-get /usr/bin/apt-cache 2>/dev/null || true;     rm -f /usr/bin/dpkg /usr/bin/dpkg-deb /usr/bin/dpkg-query 2>/dev/null || true;     echo \"‚úì Package manager binaries removed (apt, dpkg)\";     echo \"Note: OpenSCAP scanning must be done before this step\"" did not complete successfully: exit code: 1

========================================
[0;31m‚úó BUILD FAILED[0m
========================================
========================================
Building Hardened FIPS Image
========================================
Image: coredns:v1.13.2-ubuntu-22.04-fips
Dockerfile: Dockerfile.hardened

#0 building with "default" instance using docker driver

#1 [internal] load build definition from Dockerfile.hardened
#1 transferring dockerfile: 49.61kB done
#1 DONE 0.0s

#2 [internal] load metadata for docker.io/library/ubuntu:22.04
#2 DONE 0.1s

#3 [internal] load .dockerignore
#3 transferring context: 2B done
#3 DONE 0.0s

#4 [go-builder 1/9] FROM docker.io/library/ubuntu:22.04@sha256:aa6efdd564b660b6df78df8f4bca20dbb8338c46fb696d4b45c4a57b8f66679f
#4 resolve docker.io/library/ubuntu:22.04@sha256:aa6efdd564b660b6df78df8f4bca20dbb8338c46fb696d4b45c4a57b8f66679f 0.0s done
#4 DONE 0.0s

#5 [internal] load build context
#5 transferring context: 115B done
#5 DONE 0.0s

#6 [stage-5 31/51] RUN usermod -g 0 root && for user in $(awk -F: '($3 < 1000 && $1 != "root" && $1 != "sync" && $1 != "shutdown" && $1 != "halt") {print $1}' /etc/passwd); do usermod -s /usr/sbin/nologin "$user" 2>/dev/null || true; done
#6 CACHED

#7 [go-builder 3/9] COPY --from=wolfssl-builder /usr/local/include/wolfssl /usr/local/include/wolfssl
#7 CACHED

#8 [wolfprov-builder 6/6] RUN set -eux;     cd /tmp;     git clone --depth 1 --branch v1.1.0 https://github.com/wolfSSL/wolfProvider.git wolfProvider;     cd wolfProvider;     ./autogen.sh;     ./configure         --prefix=/usr/local         --with-openssl=/usr/local/openssl         --with-wolfssl=/usr/local     ;     make -j"$(nproc)";     make install;     echo "Checking installed wolfProvider files:";     find /usr/local -name "libwolfprov.so*" -ls || echo "wolfProvider not in expected location";     find /usr/local/openssl -name "libwolfprov.so*" -ls || echo "wolfProvider not in OpenSSL location"
#8 CACHED

#9 [stage-5 43/51] RUN mkdir -p /etc/apt/apt.conf.d && cat > /etc/apt/apt.conf.d/90autoremove << 'APT_CONF_EOF'
#9 CACHED

#10 [stage-5 35/51] RUN mkdir -p /etc/ssh/sshd_config.d && cat > /etc/ssh/sshd_config.d/99-stig-hardening.conf << 'SSH_EOF'
#10 CACHED

#11 [stage-5 30/51] RUN sed -i 's/^UMASK.*/UMASK 077/' /etc/login.defs &&     sed -i '1i umask 077' /etc/profile &&     echo "umask 077" >> /etc/bash.bashrc &&     mkdir -p /etc/profile.d &&     echo "umask 077" > /etc/profile.d/umask.sh &&     chmod 0644 /etc/profile.d/umask.sh
#11 CACHED

#12 [stage-5 14/51] COPY --from=wolfssl-builder /usr/local/bin/fips-startup-check /usr/local/bin/fips-startup-check
#12 CACHED

#13 [app-builder 4/9] COPY --from=wolfssl-builder /usr/local/include/wolfssl /usr/local/include/wolfssl
#13 CACHED

#14 [app-builder 3/9] COPY --from=openssl-builder /usr/local/openssl /usr/local/openssl
#14 CACHED

#15 [stage-5 40/51] RUN find / -xdev -nouser -exec chown root {} ; 2>/dev/null || true &&     find / -xdev -nogroup -exec chgrp root {} ; 2>/dev/null || true &&     chmod 0750 /var/log && chown root:syslog /var/log 2>/dev/null || chown root:root /var/log &&     find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type d -exec chmod 0755 {} ; 2>/dev/null || true &&     find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type f -exec chown root {} ; 2>/dev/null || true &&     find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type f -exec chgrp root {} ; 2>/dev/null || true
#15 CACHED

#16 [stage-5  3/51] COPY --from=wolfssl-builder /usr/local/lib/libwolfssl.* /usr/local/lib/
#16 CACHED

#17 [stage-5 33/51] RUN cat > /etc/sysctl.d/99-stig-hardening.conf << 'STIG_EOF'
#17 CACHED

#18 [openssl-builder 3/3] RUN set -eux;     cd /tmp;     curl -fsSL "https://www.openssl.org/source/openssl-3.0.18.tar.gz" -o openssl.tar.gz;     tar -xzf openssl.tar.gz;     cd "openssl-3.0.18";     ARCH=$(uname -m);     if [ "$ARCH" = "x86_64" ]; then OPENSSL_TARGET="linux-x86_64"; OPENSSL_LIBDIR="lib64";     elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then OPENSSL_TARGET="linux-aarch64"; OPENSSL_LIBDIR="lib";     else OPENSSL_TARGET="linux-generic64"; OPENSSL_LIBDIR="lib"; fi;     ./Configure --prefix=/usr/local/openssl --libdir=$OPENSSL_LIBDIR --openssldir=/usr/local/openssl/ssl enable-fips shared $OPENSSL_TARGET;     make -j"$(nproc)";     make install_sw install_fips install_ssldirs;     if [ -d "/usr/local/openssl/lib64" ] && [ ! -d "/usr/local/openssl/lib" ]; then ln -sf lib64 /usr/local/openssl/lib;     elif [ -d "/usr/local/openssl/lib" ] && [ ! -d "/usr/local/openssl/lib64" ]; then ln -sf lib /usr/local/openssl/lib64; fi;     cd /tmp; rm -rf openssl*
#18 CACHED

#19 [go-builder 8/9] RUN set -eux;     unset GOROOT;     export PATH="/usr/local/go-bootstrap/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin";     git config --global user.email "builder@fips.local";     git config --global user.name "FIPS Builder";     git clone --branch go1.24-fips-release https://github.com/golang-fips/go.git /tmp/go-fips-repo;     cd /tmp/go-fips-repo;     git submodule update --init --recursive;     cd /tmp/go-fips-repo;     ./scripts/full-initialize-repo.sh;     cd /tmp/go-fips-repo/go/src;     CGO_ENABLED=1     CGO_CFLAGS="-I/usr/local/openssl/include -I/usr/local/include"     CGO_LDFLAGS="-L/usr/local/openssl/lib64 -L/usr/local/openssl/lib -L/usr/local/lib"     ./make.bash;     FINAL_GOROOT=/usr/local/go-fips;     mv /tmp/go-fips-repo/go ${FINAL_GOROOT};     rm -rf /tmp/go-fips-repo;     ${FINAL_GOROOT}/bin/go version
#19 CACHED

#20 [stage-5 47/51] RUN find / -perm /6000 -type f -exec chmod a-s {} ; 2>/dev/null || true
#20 CACHED

#21 [stage-5 18/51] COPY entrypoint.sh /entrypoint.sh
#21 CACHED

#22 [stage-5 39/51] RUN find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type f -perm /022 -exec chmod go-w {} ; 2>/dev/null || true
#22 CACHED

#23 [stage-5  8/51] RUN set -eux;     cp -av /usr/local/openssl/bin/openssl /usr/bin/openssl || true;     chmod 755 /usr/bin/openssl
#23 CACHED

#24 [stage-5 36/51] RUN echo "Defaults use_pty" > /etc/sudoers.d/99-stig-hardening &&     echo "Defaults logfile="/var/log/sudo.log"" >> /etc/sudoers.d/99-stig-hardening &&     echo "Defaults timestamp_timeout=0" >> /etc/sudoers.d/99-stig-hardening &&     chmod 0440 /etc/sudoers.d/99-stig-hardening
#24 CACHED

#25 [stage-5 32/51] RUN echo > /etc/securetty &&     chmod 0600 /etc/securetty
#25 CACHED

#26 [stage-5 38/51] RUN chmod 0750 /etc/audit/rules.d && chmod 0640 /etc/audit/rules.d/*.rules 2>/dev/null || true
#26 CACHED

#27 [stage-5 21/51] RUN sed -i 's/^PASS_MAX_DAYS.*/PASS_MAX_DAYS   60/' /etc/login.defs &&     sed -i 's/^PASS_MIN_DAYS.*/PASS_MIN_DAYS   7/' /etc/login.defs &&     sed -i 's/^PASS_WARN_AGE.*/PASS_WARN_AGE   14/' /etc/login.defs &&     sed -i 's/^ENCRYPT_METHOD.*/ENCRYPT_METHOD SHA512/' /etc/login.defs &&     sed -i 's/^# SHA_CRYPT_MIN_ROUNDS.*/SHA_CRYPT_MIN_ROUNDS 5000/' /etc/login.defs &&     sed -i 's/^# SHA_CRYPT_MAX_ROUNDS.*/SHA_CRYPT_MAX_ROUNDS 5000/' /etc/login.defs &&     useradd -D -f 30
#27 CACHED

#28 [stage-5  7/51] RUN set -eux;     echo "Installing FIPS OpenSSL to system locations...";     cp -av /usr/local/openssl/lib64/libssl.so* /usr/lib/x86_64-linux-gnu/ || true;     cp -av /usr/local/openssl/lib64/libcrypto.so* /usr/lib/x86_64-linux-gnu/ || true;     cp -av /usr/local/lib/libwolfssl.so* /usr/lib/x86_64-linux-gnu/ || true;     echo "/usr/local/openssl/lib64" > /etc/ld.so.conf.d/fips-openssl.conf;     echo "/usr/local/lib" >> /etc/ld.so.conf.d/fips-openssl.conf;     echo "/usr/lib/x86_64-linux-gnu" >> /etc/ld.so.conf.d/fips-openssl.conf;     ldconfig;     echo "FIPS OpenSSL installed to system locations"
#28 CACHED

#29 [stage-5 41/51] RUN find /var/log -type f -exec chmod 0640 {} ; 2>/dev/null || true &&     find /var/log -type f -exec chown root:syslog {} ; 2>/dev/null || true
#29 CACHED

#30 [wolfssl-builder 3/5] RUN --mount=type=secret,id=wolfssl_password,required=true     set -eux;     mkdir -p /usr/src;     curl -fsSLk "https://www.wolfssl.com/comm/wolfssl/wolfssl-5.8.2-commercial-fips-v5.2.3.7z" -o /tmp/wolfssl.7z;     PASSWORD=$(cat /run/secrets/wolfssl_password | tr -d '\n\r');     7z x /tmp/wolfssl.7z -o/usr/src -p"${PASSWORD}";     rm /tmp/wolfssl.7z;     find /usr/src -maxdepth 1 -type d -name "wolfssl*" -exec mv {} /usr/src/wolfssl ;;     cd /usr/src/wolfssl;     sed -i '/^#ifdef WOLFSSL_PYTHON/,/^#endif/d' wolfssl/wolfcrypt/settings.h || true;     ./configure         --prefix=/usr/local         --enable-fips=v5         --enable-opensslcoexist         --enable-cmac         --enable-keygen         --enable-sha         --enable-des3         --enable-aesctr         --enable-aesccm         --enable-x963kdf         --enable-compkey         --enable-certgen         --enable-aeskeywrap         --enable-enckeys         --enable-base16         --with-eccminsz=192         CPPFLAGS="-DHAVE_AES_ECB -DWOLFSSL_AES_DIRECT -DWC_RSA_NO_PADDING -DWOLFSSL_PUBLIC_MP -DHAVE_PUBLIC_FFDHE -DWOLFSSL_DH_EXTRA -DWOLFSSL_PSS_LONG_SALT -DWOLFSSL_PSS_SALT_LEN_DISCOVER -DRSA_MIN_SIZE=1024"     ;     make -j"$(nproc)";     ./fips-hash.sh;     make -j"$(nproc)";     make install;     ldconfig;     cd /;     rm -rf /usr/src/wolfssl;     echo "wolfSSL FIPS v5 installed successfully"
#30 CACHED

#31 [stage-5 34/51] RUN echo "Authorized uses only. All activity may be monitored and reported." > /etc/motd &&     echo "Authorized uses only. All activity may be monitored and reported." > /etc/issue &&     echo "Authorized uses only. All activity may be monitored and reported." > /etc/issue.net
#31 CACHED

#32 [wolfprov-builder 5/6] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends         build-essential         ca-certificates         git         autoconf         automake         libtool         pkg-config     ;     rm -rf /var/lib/apt/lists/*
#32 CACHED

#33 [go-builder 5/9] COPY --from=wolfprov-builder /usr/local/openssl/lib64/ossl-modules/libwolfprov.so* /usr/local/openssl/lib64/ossl-modules/
#33 CACHED

#34 [stage-5 23/51] RUN sed -i '1i auth required pam_faildelay.so delay=4000000' /etc/pam.d/common-auth &&     echo "deny = 3" > /etc/security/faillock.conf &&     echo "fail_interval = 900" >> /etc/security/faillock.conf &&     echo "unlock_time = 900" >> /etc/security/faillock.conf &&     echo "silent" >> /etc/security/faillock.conf &&     echo "audit" >> /etc/security/faillock.conf
#34 CACHED

#35 [stage-5 27/51] RUN groupadd sugroup 2>/dev/null || true && gpasswd -M '' sugroup &&     mkdir -p /etc/pam.d &&     if [ -f /etc/pam.d/su ]; then         grep -q "pam_wheel.so.*group=sugroup" /etc/pam.d/su || sed -i '/^auth.*pam_rootok\.so/a auth required pam_wheel.so use_uid group=sugroup' /etc/pam.d/su;     else         echo "auth sufficient pam_rootok.so" > /etc/pam.d/su &&         echo "auth required pam_wheel.so use_uid group=sugroup" >> /etc/pam.d/su &&         echo "@include common-auth" >> /etc/pam.d/su &&         echo "@include common-account" >> /etc/pam.d/su &&         echo "@include common-session" >> /etc/pam.d/su;     fi
#35 CACHED

#36 [stage-5  6/51] RUN --mount=type=bind,from=wolfprov-builder,source=/usr/local,target=/mnt/wolfprov     set -eux;     echo "Searching for wolfProvider...";     find /mnt/wolfprov -name "libwolfprov.so*" -ls || true;     if [ -f "/mnt/wolfprov/lib/libwolfprov.so" ]; then         echo "Copying wolfProvider from /usr/local/lib/";         cp -v /mnt/wolfprov/lib/libwolfprov.so* /usr/local/openssl/lib64/ossl-modules/;         echo "Creating symlink without lib prefix for OpenSSL compatibility...";         ln -sf libwolfprov.so /usr/local/openssl/lib64/ossl-modules/wolfprov.so;     else         echo "ERROR: wolfProvider not found!";         exit 1;     fi;     echo "Final wolfProvider verification:";     ls -la /usr/local/openssl/lib64/ossl-modules/
#36 CACHED

#37 [stage-5 44/51] RUN cat > /etc/apt/apt.conf-stig << 'APT_CONF_STIG_EOF'
#37 CACHED

#38 [stage-5 45/51] RUN usermod -g 0 root 2>/dev/null || true
#38 CACHED

#39 [stage-5 15/51] RUN chmod +x /usr/local/bin/fips-startup-check
#39 CACHED

#40 [stage-5 11/51] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends         ca-certificates         iproute2         bash         curl         procps     ;     rm -rf /var/lib/apt/lists/*
#40 CACHED

#41 [stage-5 19/51] RUN chmod +x /entrypoint.sh
#41 CACHED

#42 [stage-5 13/51] RUN set -eux;     echo "Removing system OpenSSL packages...";     apt-get remove -y libssl3 openssl libssl-dev 2>/dev/null || true;     apt-get autoremove -y 2>/dev/null || true;     find /usr/lib /lib -name "libssl.so.3" -delete 2>/dev/null || true;     find /usr/lib /lib -name "libcrypto.so.3" -delete 2>/dev/null || true;     cp -av /usr/local/openssl/lib64/libssl.so* /usr/lib/x86_64-linux-gnu/ 2>/dev/null || true;     cp -av /usr/local/openssl/lib64/libcrypto.so* /usr/lib/x86_64-linux-gnu/ 2>/dev/null || true;     cp -av /usr/local/lib/libwolfssl.so* /usr/lib/x86_64-linux-gnu/ 2>/dev/null || true;     ldconfig;     echo "System OpenSSL packages removed"
#42 CACHED

#43 [go-builder 9/9] RUN set -eux;     echo "";     echo "========================================";     echo "CVE-2024-9355 Verification";     echo "========================================";     echo "Checking golang-fips/openssl version for CVE-2024-9355...";     cd /usr/local/go-fips;     if [ -f "go.mod" ]; then         OPENSSL_VERSION=$(grep "github.com/golang-fips/openssl" go.mod | head -1 | awk '{print $2}' || echo "unknown");         echo "Detected golang-fips/openssl version: $OPENSSL_VERSION";         echo "";         case "$OPENSSL_VERSION" in             v2.0.[0-3]|v2.0.0-*|v2.0.1-*|v2.0.2-*|v2.0.3-*|v0.*|v1.*)                 echo "‚ö†Ô∏è  WARNING: golang-fips/openssl version $OPENSSL_VERSION may be VULNERABLE";                 echo "";                 echo "Vulnerability Details:";                 echo "  CVE ID: CVE-2024-9355";                 echo "  Severity: HIGH (CVSS 6.5)";                 echo "  Issue: Uninitialized buffer in RSA key generation";                 echo "  Affected: golang-fips/openssl ‚â§ v2.0.3";                 echo "  Fixed in: v2.0.4+";                 echo "";                 echo "Recommendation:";                 echo "  Update golang-fips/go to use golang-fips/openssl v2.0.4 or later";                 echo "  This is detected at BUILD TIME for awareness";                 echo "";                 ;;             v2.0.[4-9]|v2.0.[1-9][0-9]|v2.[1-9]*|v[3-9]*)                 echo "‚úì PASS: golang-fips/openssl $OPENSSL_VERSION is PATCHED";                 echo "  CVE-2024-9355 does not affect this version";                 ;;             *)                 echo "‚ÑπÔ∏è  INFO: golang-fips/openssl version: $OPENSSL_VERSION";                 echo "  Could not determine vulnerability status automatically";                 echo "  Please verify version >= v2.0.4 manually";                 ;;         esac;     else         echo "‚ö†Ô∏è  WARNING: Could not find go.mod in /usr/local/go-fips";         echo "  Unable to verify golang-fips/openssl version";     fi;     echo "========================================";     echo ""
#43 CACHED

#44 [stage-5 22/51] RUN echo "minlen = 15" > /etc/security/pwquality.conf &&     echo "dcredit = -1" >> /etc/security/pwquality.conf &&     echo "ucredit = -1" >> /etc/security/pwquality.conf &&     echo "ocredit = -1" >> /etc/security/pwquality.conf &&     echo "lcredit = -1" >> /etc/security/pwquality.conf &&     echo "minclass = 4" >> /etc/security/pwquality.conf &&     echo "maxrepeat = 3" >> /etc/security/pwquality.conf &&     echo "maxsequence = 3" >> /etc/security/pwquality.conf &&     echo "dictcheck = 1" >> /etc/security/pwquality.conf &&     echo "enforcing = 1" >> /etc/security/pwquality.conf &&     echo "difok = 8" >> /etc/security/pwquality.conf
#44 CACHED

#45 [stage-5 16/51] COPY --from=app-builder /app/coredns /coredns
#45 CACHED

#46 [wolfssl-builder 5/5] RUN set -eux;     gcc /tmp/fips-startup-check.c -o /usr/local/bin/fips-startup-check         -lwolfssl -I/usr/local/include;     chmod +x /usr/local/bin/fips-startup-check;     rm /tmp/fips-startup-check.c;     echo "FIPS startup check utility built successfully"
#46 CACHED

#47 [stage-5 20/51] RUN set -eux;     echo "";     echo "========================================";     echo "Final FIPS Compliance Verification";     echo "========================================";     echo "";     echo "[1/6] OpenSSL Version:";     /usr/local/openssl/bin/openssl version;     echo "";     echo "[2/6] OpenSSL Providers:";     /usr/local/openssl/bin/openssl list -providers;     echo "";     echo "[3/6] wolfProvider Module Location:";     ls -lah /usr/local/openssl/lib64/ossl-modules/;     echo "";     echo "[4/6] CoreDNS Binary:";     ls -lh /coredns;     echo "";     echo "[5/6] Verifying wolfProvider is Active:";     if /usr/local/openssl/bin/openssl list -providers | grep -q "wolfprov"; then         echo "‚úì wolfProvider is loaded and active";     else         echo "‚úó ERROR: wolfProvider is NOT loaded!";         exit 1;     fi;     echo "";     echo "[6/6] Scanning for Non-FIPS Crypto Libraries:";     FOUND_LIBS=$(find /usr/lib /lib -type f (         -name 'libgnutls*' -o         -name 'libnettle*' -o         -name 'libhogweed*' -o         -name 'libgcrypt*' -o         -name 'libk5crypto*'     ) 2>/dev/null | wc -l);     if [ "$FOUND_LIBS" -eq 0 ]; then         echo "‚úì No non-FIPS crypto libraries found";     else         echo "‚úó WARNING: Found $FOUND_LIBS non-FIPS crypto library files:";         find /usr/lib /lib -type f (             -name 'libgnutls*' -o             -name 'libnettle*' -o             -name 'libhogweed*' -o             -name 'libgcrypt*' -o             -name 'libk5crypto*'         ) 2>/dev/null || true;     fi;     echo "";     echo "========================================";     echo "‚úì FIPS Compliance Verification Complete";     echo "========================================";     echo "";     echo "Environment Summary:";     echo "  OPENSSL_CONF: /usr/local/openssl/ssl/openssl.cnf";     echo "  OPENSSL_MODULES: /usr/local/openssl/lib64/ossl-modules";     echo "  LD_LIBRARY_PATH: /usr/local/openssl/lib64:/usr/local/openssl/lib:/usr/local/lib:/usr/lib/x86_64-linux-gnu:/usr/lib/aarch64-linux-gnu:/usr/lib";     echo "  PATH: /usr/local/openssl/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin";     echo "";     echo "Architecture:";     echo "  CoreDNS ‚Üí golang-fips/go ‚Üí OpenSSL 3 ‚Üí wolfProvider ‚Üí wolfSSL FIPS v5";     echo ""
#47 CACHED

#48 [stage-5  9/51] COPY openssl-wolfprov.cnf /usr/local/openssl/ssl/openssl.cnf
#48 CACHED

#49 [stage-5 26/51] RUN mkdir -p /etc/pam.d &&     if [ -f /etc/pam.d/login ]; then         sed -i 's/^session.*optional.*pam_lastlog\.so.*/session required pam_lastlog.so showfailed/' /etc/pam.d/login;         grep -q "pam_lastlog.so showfailed" /etc/pam.d/login || echo "session required pam_lastlog.so showfailed" >> /etc/pam.d/login;     else         echo "session required pam_lastlog.so showfailed" > /etc/pam.d/login;     fi
#49 CACHED

#50 [app-builder 5/9] COPY --from=wolfssl-builder /usr/local/lib/libwolfssl.* /usr/local/lib/
#50 CACHED

#51 [app-builder 9/9] RUN set -eux;     echo "";     echo "========================================";     echo "CoreDNS Crypto Dependency Audit";     echo "========================================";     echo "";     echo "Scanning /app/coredns binary for cryptographic references...";     echo "";     X_CRYPTO_COUNT=$(strings /app/coredns 2>/dev/null | grep -c "golang.org/x/crypto" || echo 0);     if [ "$X_CRYPTO_COUNT" -gt 0 ]; then         echo "‚ö†Ô∏è  WARNING: Found $X_CRYPTO_COUNT golang.org/x/crypto references";         echo "";         echo "Details:";         echo "  Package: golang.org/x/crypto (v0.45.0 in go.mod)";         echo "  Used by: CoreDNS TLS plugins (DoT/DoH/DoH3)";         echo "  Expected: golang-fips/go SHOULD intercept these calls at runtime";         echo "";         echo "FIPS Compliance Path:";         echo "  CoreDNS ‚Üí golang.org/x/crypto ‚Üí golang-fips/go runtime";         echo "  ‚Üí OpenSSL 3.0.15 ‚Üí wolfProvider ‚Üí wolfSSL FIPS v5";         echo "";         echo "‚ö†Ô∏è  Action Required:";         echo "  Integration testing with TLS connections (DoT/DoH/DoH3) to verify";         echo "  crypto routing through FIPS-validated OpenSSL in production";         echo "";     else         echo "‚úì No golang.org/x/crypto references found";     fi;     X25519_COUNT=$(strings /app/coredns 2>/dev/null | grep -icE "x25519|curve25519" || echo 0);     if [ "$X25519_COUNT" -gt 0 ]; then         echo "‚ö†Ô∏è  WARNING: Found $X25519_COUNT X25519/curve25519 references";         echo "";         echo "Details:";         echo "  Algorithm: X25519 elliptic curve Diffie-Hellman";         echo "  Used in: TLS 1.3 key exchange (DoT/DoH/DoH3)";         echo "  FIPS Status: May be approved in FIPS 140-3";         echo "";         echo "Expected Behavior:";         echo "  golang-fips/go routes crypto/ecdh and crypto/tls calls to OpenSSL";         echo "  OpenSSL 3.0.15 uses wolfProvider ‚Üí wolfSSL FIPS v5 for operations";         echo "";         echo "‚ö†Ô∏è  Action Required:";         echo "  Test TLS connections in production environment";         echo "  Verify cipher suite negotiation uses FIPS-approved algorithms";         echo "  Monitor for TLS handshake errors";         echo "";     else         echo "‚ÑπÔ∏è  No X25519/curve25519 references found";     fi;     ED25519_COUNT=$(strings /app/coredns 2>/dev/null | grep -ic "ed25519" || echo 0);     if [ "$ED25519_COUNT" -gt 0 ]; then         echo "‚ÑπÔ∏è  INFO: Found $ED25519_COUNT Ed25519 references";         echo "";         echo "Details:";         echo "  Algorithm: Ed25519 signature algorithm";         echo "  Used in: DNSSEC record signatures, JWT token verification";         echo "  Operation: Signature VERIFICATION (non-cryptographic)";         echo "";         echo "FIPS Impact: LOW";         echo "  Signature verification is a public-key operation";         echo "  Does not involve key generation or signing (cryptographic operations)";         echo "";     else         echo "‚ÑπÔ∏è  No Ed25519 references found";     fi;     CHACHA20_COUNT=$(strings /app/coredns 2>/dev/null | grep -ic "chacha20" || echo 0);     if [ "$CHACHA20_COUNT" -gt 0 ]; then         echo "‚ö†Ô∏è  WARNING: Found $CHACHA20_COUNT ChaCha20 references";         echo "";         echo "Details:";         echo "  Algorithm: ChaCha20-Poly1305 AEAD cipher";         echo "  Used in: TLS 1.3 cipher suites (optional)";         echo "  FIPS Status: NOT FIPS-approved";         echo "";         echo "‚ö†Ô∏è  Action Required:";         echo "  Configure TLS to use only FIPS-approved cipher suites";         echo "  Example: AES-128-GCM-SHA256, AES-256-GCM-SHA384";         echo "  Disable ChaCha20-Poly1305 in TLS configuration";         echo "";     else         echo "‚úì No ChaCha20 references found";     fi;     echo "";     echo "Summary:";     echo "  Architecture: CoreDNS ‚Üí golang-fips/go ‚Üí OpenSSL 3 ‚Üí wolfProvider ‚Üí wolfSSL FIPS v5";     echo "  golang.org/x/crypto: $X_CRYPTO_COUNT references (expected for TLS plugins)";     echo "  X25519: $X25519_COUNT references (TLS 1.3 key exchange)";     echo "  Ed25519: $ED25519_COUNT references (DNSSEC/JWT verification)";     echo "  ChaCha20: $CHACHA20_COUNT references (should be 0 for FIPS)";     echo "";     echo "Next Steps:";     echo "  1. Run automated tests: ./tests/check-coredns-crypto-routing.sh";     echo "  2. Deploy to test environment with TLS enabled";     echo "  3. Test DoT, DoH, DoH3 with real DNS queries";     echo "  4. Verify TLS cipher suites in production logs";     echo "";     echo "========================================";     echo ""
#51 CACHED

#52 [go-builder 4/9] COPY --from=wolfssl-builder /usr/local/lib/libwolfssl.* /usr/local/lib/
#52 CACHED

#53 [app-builder 8/9] RUN set -eux;     echo "Cloning CoreDNS repository...";     git clone --depth 1 --branch v1.13.2         https://github.com/coredns/coredns.git /tmp/coredns;     cd /tmp/coredns;     echo "Building CoreDNS v1.13.2 with FIPS Go...";     go version;     echo "Downloading dependencies...";     go mod download;     echo "Building CoreDNS binary...";     go build -buildmode=pie         -ldflags="-s -w"         -o /app/coredns         .;     echo "Verifying CoreDNS binary...";     ls -lh /app/coredns;     echo "Checking binary linkage:";     ldd /app/coredns || echo "Note: Binary linkage check complete";     echo "Testing binary execution:";     /app/coredns --version 2>&1 || echo "Binary execution test complete";     cd /;     rm -rf /tmp/coredns
#53 CACHED

#54 [stage-5 46/51] RUN set -eux;     echo "========================================";     echo "Final System Executable Permission Check";     echo "========================================";     find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type f -exec chmod 0755 {} ; 2>/dev/null || true;     find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type f -exec chown root:root {} ; 2>/dev/null || true;     find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type d -exec chmod 0755 {} ; 2>/dev/null || true;     echo "‚úì All system executables have restrictive permissions (0755)"
#54 CACHED

#55 [stage-5  4/51] COPY --from=wolfssl-builder /usr/local/include/wolfssl /usr/local/include/wolfssl
#55 CACHED

#56 [stage-5 48/51] RUN set -eux;     groupadd -g 1001 coredns;     useradd -u 1001 -g coredns -s /bin/bash -m coredns
#56 CACHED

#57 [wolfssl-builder 2/5] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends         build-essential         ca-certificates         curl         git         autoconf         automake         libtool         p7zip-full     ;     rm -rf /var/lib/apt/lists/*
#57 CACHED

#58 [app-builder 2/9] COPY --from=go-builder /usr/local/go-fips /usr/local/go-fips
#58 CACHED

#59 [go-builder 2/9] COPY --from=openssl-builder /usr/local/openssl /usr/local/openssl
#59 CACHED

#60 [stage-5 29/51] RUN chmod 0644 /etc/passwd /etc/group &&     chmod 0640 /etc/shadow /etc/gshadow &&     chown root:root /etc/passwd /etc/group &&     chown root:shadow /etc/shadow /etc/gshadow &&     chmod 0644 /etc/passwd- /etc/group- 2>/dev/null || true &&     chmod 0000 /etc/shadow- /etc/gshadow- 2>/dev/null || true
#60 CACHED

#61 [stage-5 10/51] RUN set -eux;     echo "";     echo "========================================";     echo "Pre-Installation FIPS Verification";     echo "========================================";     echo "";     echo "OpenSSL Version:";     openssl version || { echo "ERROR: OpenSSL not working!"; exit 1; };     echo "";     echo "OpenSSL Providers:";     openssl list -providers || { echo "ERROR: Cannot list providers!"; exit 1; };     echo "";     echo "Checking for wolfProvider...";     if openssl list -providers | grep -q "wolfprov"; then         echo "‚úì SUCCESS: wolfProvider is loaded and active";     else         echo "‚úó ERROR: wolfProvider is NOT loaded!";         echo "Available providers:";         openssl list -providers || true;         exit 1;     fi;     echo "";     echo "‚úì Pre-installation FIPS verification passed";     echo "========================================"
#61 CACHED

#62 [app-builder 6/9] COPY --from=wolfprov-builder /usr/local/openssl/lib64/ossl-modules/libwolfprov.so* /usr/local/openssl/lib64/ossl-modules/
#62 CACHED

#63 [go-builder 6/9] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends         build-essential         ca-certificates         git         curl         pkg-config     ;     rm -rf /var/lib/apt/lists/*
#63 CACHED

#64 [go-builder 7/9] RUN set -eux;     ARCH=$(uname -m);     if [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then GO_ARCH="arm64"; else GO_ARCH="amd64"; fi;     curl -fsSL https://go.dev/dl/go1.23.4.linux-${GO_ARCH}.tar.gz -o /tmp/go.tar.gz;     tar -C /usr/local -xzf /tmp/go.tar.gz;     mv /usr/local/go /usr/local/go-bootstrap;     rm /tmp/go.tar.gz
#64 CACHED

#65 [app-builder 7/9] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends         build-essential         ca-certificates         curl         git         pkg-config     ;     rm -rf /var/lib/apt/lists/*
#65 CACHED

#66 [stage-5 28/51] RUN mkdir -p /etc/security/limits.d &&     echo "* hard maxlogins 10" > /etc/security/limits.d/maxlogins.conf &&     echo "* hard core 0" > /etc/security/limits.d/core.conf &&     chmod 0644 /etc/security/limits.d/*.conf
#66 CACHED

#67 [stage-5 37/51] RUN mkdir -p /etc/audit/rules.d && cat > /etc/audit/rules.d/stig.rules << 'AUDIT_EOF'
#67 CACHED

#68 [stage-5 25/51] RUN sed -i 's/\(password.*pam_unix\.so.*\)obscure.*/\1obscure sha512/' /etc/pam.d/common-password ||     sed -i '/^password.*pam_unix\.so/s/yescrypt/sha512/' /etc/pam.d/common-password ||     sed -i '/^password.*pam_unix\.so/s/$/ sha512/' /etc/pam.d/common-password;     sed -i 's/\(password.*pam_unix\.so.*sha512\)/\1 remember=5/' /etc/pam.d/common-password
#68 CACHED

#69 [openssl-builder 2/3] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends         build-essential         ca-certificates         curl         perl     ;     rm -rf /var/lib/apt/lists/*
#69 CACHED

#70 [wolfssl-builder 4/5] COPY fips-startup-check.c /tmp/fips-startup-check.c
#70 CACHED

#71 [stage-5 42/51] RUN apt-get purge -y xinetd rsh-client talk telnet 2>/dev/null || true &&     apt-get autoremove -y || true &&     apt-get clean || true &&     rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
#71 CACHED

#72 [stage-5  5/51] RUN mkdir -p /usr/local/openssl/lib64/ossl-modules
#72 CACHED

#73 [stage-5 24/51] RUN sed -i '/^auth.*pam_unix\.so/i auth required pam_faillock.so preauth' /etc/pam.d/common-auth &&     sed -i '/^auth.*pam_unix\.so/a auth [default=die] pam_faillock.so authfail' /etc/pam.d/common-auth &&     sed -i '/^auth.*pam_permit\.so/i auth sufficient pam_faillock.so authsucc' /etc/pam.d/common-auth &&     sed -i '/^account.*pam_unix\.so/a account required pam_faillock.so' /etc/pam.d/common-account || true &&     if ! grep -q "pam_faillock.so" /etc/pam.d/common-account; then sed -i '1i account required pam_faillock.so' /etc/pam.d/common-account; fi
#73 CACHED

#74 [stage-5 12/51] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends         libpam-pwquality         libpam-runtime         auditd         rsyslog-openssl         sudo         libopenscap8;     apt-get clean;     rm -rf /var/lib/apt/lists/*;         echo "========================================";     echo "Verifying FIPS Compliance of Installed Packages";     echo "========================================";         echo "Checking rsyslog linkage:";     ldd /usr/sbin/rsyslogd | grep -E "libssl|libcrypto" || echo "  (no OpenSSL linkage)";         if ldd /usr/sbin/rsyslogd 2>/dev/null | grep libssl; then         if ldd /usr/sbin/rsyslogd | grep libssl | grep -q "/usr/lib/x86_64-linux-gnu"; then             echo "‚úì rsyslog-openssl uses FIPS OpenSSL (TLS logging is FIPS-compliant)";         else             echo "ERROR: rsyslog links to non-FIPS OpenSSL!";             ldd /usr/sbin/rsyslogd | grep libssl;             exit 1;         fi;     fi;         if command -v oscap &>/dev/null; then         echo "‚úì OpenSCAP installed for compliance scanning";         oscap --version | head -1 || true;     fi;         echo "‚úì All hardening packages verified";     echo "========================================"
#74 CACHED

#75 [stage-5 17/51] RUN chmod +x /coredns
#75 CACHED

#76 [stage-5 49/51] RUN set -eux;     mkdir -p /etc/coredns;     mkdir -p /var/log/coredns;     chown -R 1001:1001 /etc/coredns /var/log/coredns;     chmod 755 /etc/coredns /var/log/coredns
#76 CACHED

#77 [stage-5 50/51] RUN set -eux;     echo "========================================";     echo "Removing Package Manager Binaries";     echo "========================================";     dpkg-divert --add --rename --divert /usr/bin/apt.real /usr/bin/apt 2>/dev/null || true;     dpkg-divert --add --rename --divert /usr/bin/apt-get.real /usr/bin/apt-get 2>/dev/null || true;     dpkg-divert --add --rename --divert /usr/bin/apt-cache.real /usr/bin/apt-cache 2>/dev/null || true;     dpkg-divert --add --rename --divert /usr/bin/dpkg.real /usr/bin/dpkg 2>/dev/null || true;     dpkg-divert --add --rename --divert /usr/bin/dpkg-deb.real /usr/bin/dpkg-deb 2>/dev/null || true;     dpkg-divert --add --rename --divert /usr/bin/dpkg-query.real /usr/bin/dpkg-query 2>/dev/null || true;     rm -f /usr/bin/apt.real /usr/bin/apt-get.real /usr/bin/apt-cache.real;     rm -f /usr/bin/dpkg.real /usr/bin/dpkg-deb.real /usr/bin/dpkg-query.real;     rm -f /usr/bin/aptitude 2>/dev/null || true;     rm -f /usr/bin/apt-key 2>/dev/null || true;     rm -f /usr/bin/apt /usr/bin/apt-get /usr/bin/apt-cache 2>/dev/null || true;     rm -f /usr/bin/dpkg /usr/bin/dpkg-deb /usr/bin/dpkg-query 2>/dev/null || true;     echo "‚úì Package manager binaries removed (apt, dpkg)";     echo "Note: OpenSCAP scanning must be done before this step"
#77 0.166 + echo ========================================
#77 0.166 + echo Removing Package Manager Binaries
#77 0.166 + echo ========================================
#77 0.166 + dpkg-divert --add --rename --divert /usr/bin/apt.real /usr/bin/apt
#77 0.166 ========================================
#77 0.166 Removing Package Manager Binaries
#77 0.166 ========================================
#77 0.170 Adding 'local diversion of /usr/bin/apt to /usr/bin/apt.real'
#77 0.170 + true
#77 0.170 + dpkg-divert --add --rename --divert /usr/bin/apt-get.real /usr/bin/apt-get
#77 0.173 Adding 'local diversion of /usr/bin/apt-get to /usr/bin/apt-get.real'
#77 0.173 + true
#77 0.173 + dpkg-divert --add --rename --divert /usr/bin/apt-cache.real /usr/bin/apt-cache
#77 0.176 Adding 'local diversion of /usr/bin/apt-cache to /usr/bin/apt-cache.real'
#77 0.177 + true
#77 0.177 + dpkg-divert --add --rename --divert /usr/bin/dpkg.real /usr/bin/dpkg
#77 0.180 Adding 'local diversion of /usr/bin/dpkg to /usr/bin/dpkg.real'
#77 0.180 + true
#77 0.180 + dpkg-divert --add --rename --divert /usr/bin/dpkg-deb.real /usr/bin/dpkg-deb
#77 0.183 Adding 'local diversion of /usr/bin/dpkg-deb to /usr/bin/dpkg-deb.real'
#77 0.183 + true
#77 0.184 + dpkg-divert --add --rename --divert /usr/bin/dpkg-query.real /usr/bin/dpkg-query
#77 0.187 Adding 'local diversion of /usr/bin/dpkg-query to /usr/bin/dpkg-query.real'
#77 0.187 + true
#77 0.187 + rm -f /usr/bin/apt.real /usr/bin/apt-get.real /usr/bin/apt-cache.real
#77 0.188 + rm -f /usr/bin/dpkg.real /usr/bin/dpkg-deb.real /usr/bin/dpkg-query.real
#77 0.189 + rm -f /usr/bin/aptitude
#77 0.190 + rm -f /usr/bin/apt-key
#77 0.191 + true
#77 0.191 + rm -f /usr/bin/apt /usr/bin/apt-get /usr/bin/apt-cache
#77 0.192 + true
#77 0.192 + rm -f /usr/bin/dpkg /usr/bin/dpkg-deb /usr/bin/dpkg-query
#77 0.193 ‚úì Package manager binaries removed (apt, dpkg)
#77 0.193 Note: OpenSCAP scanning must be done before this step
#77 0.193 + true
#77 0.193 + echo ‚úì Package manager binaries removed (apt, dpkg)
#77 0.193 + echo Note: OpenSCAP scanning must be done before this step
#77 DONE 0.2s

#78 exporting to image
#78 exporting layers
#78 exporting layers 5.4s done
#78 exporting manifest sha256:57ad9233341a496553131f36413aa53c8fa0a3de27b37ea4ccc2c4ea001f4cd1 done
#78 exporting config sha256:ebf189a52a06cf775a69e21f94158d657afc8b2cfee1ed61079cecddc21ed8e9 done
#78 exporting attestation manifest sha256:b03cdd898161247b246c5f4d36d4b8b9370fd13128adfbc31ef878763e2ef7da 0.0s done
#78 exporting manifest list sha256:951f77141ef175b21ce85874c47ca476fbffce7a624f39fce7ce18d670283f2e done
#78 naming to docker.io/library/coredns:v1.13.2-ubuntu-22.04-fips done
#78 unpacking to docker.io/library/coredns:v1.13.2-ubuntu-22.04-fips
#78 unpacking to docker.io/library/coredns:v1.13.2-ubuntu-22.04-fips 2.4s done
#78 DONE 8.0s

========================================
[0;32m‚úì BUILD SUCCESSFUL[0m
========================================

Image: coredns:v1.13.2-ubuntu-22.04-fips
Security: FIPS 140-3 + DISA STIG + CIS

Next steps:
  1. Test FIPS compliance:
     docker run --rm coredns:v1.13.2-ubuntu-22.04-fips openssl list -providers

  2. Run compliance scan:
     ./scan-internal.sh coredns:v1.13.2-ubuntu-22.04-fips

  3. Interactive shell:
     docker run -it --rm --entrypoint /bin/bash coredns:v1.13.2-ubuntu-22.04-fips

